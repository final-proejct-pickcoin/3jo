'use client';

import React, { useEffect, useMemo, useRef, useState } from "react";
import { Card, CardContent, CardHeader } from "@/components/ui/card";
import { Search } from "lucide-react";
import axios from "axios";
import TradingChart from "./trading-chart.jsx";
import OrderBook from "./trading-hoga.jsx";
import { CurrencyToggle } from "@/components/currency-toggle"
import CoinInfoPanel from "@/components/trading-coininfo"  // Ïù¥ Ï§Ñ Ï∂îÍ∞Ä

function StarIcon({ filled = false, size = 18, className = "" }) {
  const d = "M12 17.27 18.18 21 16.54 13.97 22 9.24 14.81 8.62 12 2 9.19 8.63 2 9.24 7.46 13.97 5.82 21 12 17.27Z";
  return (
    <svg viewBox="0 0 24 24" width={size} height={size} className={className} aria-hidden="true">
      {filled ? (
        <path d={d} fill="currentColor" />
      ) : (
        <path d={d} fill="none" stroke="currentColor" strokeWidth="1.6" />
      )}
    </svg>
  );
}

/* ---------------------- Î©îÏù∏ Îã®Ïùº ÌååÏùº Ïï± ---------------------- */
export default function TradingInterface() {
  // ÏÇ¨Ïö©Ïûê id Ï∂îÏ∂ú
  const [user_id, setUserId] = useState(null);

  // ÌôîÎ©¥ Ï†ÑÌôò ÏÉÅÌÉú (Î™©Î°ù/ÏÉÅÏÑ∏) - Î∞îÎ°ú ÏÉÅÏÑ∏ ÌôîÎ©¥ÏúºÎ°ú ÏãúÏûë
  const [view, setView] = useState("detail");
  
  // ÏãúÏÑ∏/ÏΩîÏù∏Ï†ïÎ≥¥ ÌÉ≠ ÏÉÅÌÉú
  const [detailView, setDetailView] = useState("chart");

  // ÏΩîÏù∏ Î™©Î°ù Í¥ÄÎ†® ÏÉÅÌÉú
  const [coinList, setCoinList] = useState([]);
  const [coinListLoading, setCoinListLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState("");
  const [selectedCoin, setSelectedCoin] = useState("BTC");

  // Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ†® ÏÉÅÌÉú
  const [realTimeData, setRealTimeData] = useState({});
  const [wsConnected, setWsConnected] = useState(false);
  const [wsStats, setWsStats] = useState({
    total_symbols: 0,
    active_subscriptions: 0,
    last_update: null
  });

  // Ìò∏Í∞ÄÏ∞Ω ÏÉÅÌÉú
  const [orderbook, setOrderbook] = useState({ bids: [], asks: [], timestamp: null });
  const [tickSize, setTickSize] = useState(1);

  // Ï£ºÎ¨∏ Í∞ÄÍ≤©/ÏàòÎüâ
  const [orderPrice, setOrderPrice] = useState(0);
  const [orderQty, setOrderQty] = useState(0);

  // Ï£ºÎ¨∏ ÌÉ≠ ÏÉÅÌÉú
  const [orderTab, setOrderTab] = useState("Í±∞Îûò");
  
  // Í±∞Îûò ÏÑúÎ∏åÌÉ≠ ÏÉÅÌÉú
  const [tradeSubTab, setTradeSubTab] = useState("Îß§Ïàò");
  
  // Í±∞ÎûòÎÇ¥Ïó≠ ÏÑúÎ∏åÌÉ≠ ÏÉÅÌÉú
  const [historyTab, setHistoryTab] = useState("Ï≤¥Í≤∞");

  // Ìò∏Í∞ÄÏ∞Ω & Í±∞ÎûòÏ†ïÎ≥¥ ÏïÑÏΩîÎîîÏñ∏ ÏÉÅÌÉú
  const [expandedSections, setExpandedSections] = useState({
    Ìò∏Í∞Ä: false,
    Í±∞ÎûòÏ†ïÎ≥¥: false
  });

  // Ï£ºÎ¨∏Ï∞Ω ÏïÑÏΩîÎîîÏñ∏ ÏÉÅÌÉú
  const [orderPanelExpanded, setOrderPanelExpanded] = useState(false);

  // Ï∞®Ìä∏ ÌÉ≠Ìå¨ ÏïÑÏΩîÎîîÏñ∏ ÏÉÅÌÉú
  const [chartPanelExpanded, setChartPanelExpanded] = useState(false);

  // Ï∞®Ìä∏ & ÏΩîÏù∏Ï†ïÎ≥¥ ÌÉ≠Ìå¨ ÏÉÅÌÉú
  const [chartTab, setChartTab] = useState("Ï∞®Ìä∏");

  // ÏõêÌôî/Î≥¥Ïú†/Í¥ÄÏã¨ ÌÉ≠ ÏÉÅÌÉú
  const [tab, setTab] = useState("won");

  // Í¥ÄÏã¨ ÏΩîÏù∏ ÏÉÅÌÉú
  const [favoriteCoins, setFavoriteCoins] = useState(new Set(["BTC", "ETH"]));

  // ÏΩîÏù∏ id(asset_id) Í∞ÄÏ†∏Ïò§Í∏∞
  const [asset_id, setAsset_id] = useState(null);

  // Responsive height
  const mainPanelRef = useRef(null);
  const [combinedHeight, setCombinedHeight] = useState(600);

  // Í¥ÄÏã¨ ÏΩîÏù∏ ÌÜ†Í∏Ä Ìï®Ïàò
  const toggleFavorite = (symbol, e) => {
    e.stopPropagation(); // ÏΩîÏù∏ ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏ Î∞©ÏßÄ
    setFavoriteCoins(prev => {
      const newSet = new Set(prev);
      if (newSet.has(symbol)) {
        newSet.delete(symbol);
      } else {
        newSet.add(symbol);
      }
      return newSet;
    });
  };

  // Ìò∏Í∞ÄÏ∞Ω & Í±∞ÎûòÏ†ïÎ≥¥ ÏïÑÏΩîÎîîÏñ∏ ÌÜ†Í∏Ä Ìï®Ïàò
  const toggleSection = (section) => {
    setExpandedSections(prev => ({
      ...prev,
      [section]: !prev[section]
    }));
  };



  // ======== ÏÇ¨Ïö©Ïûê ID Í∞ÄÏ†∏Ïò§Í∏∞ ========
  useEffect(() => {
    const cached = sessionStorage.getItem("cached_user_id");
    if (cached && user_id == null) setUserId(Number(cached));

    const tokenValue = sessionStorage.getItem("auth_token");
    if (!tokenValue) return;

    let payload = null;
    try {
      payload = JSON.parse(atob(tokenValue.split(".")[1]));
    } catch (_) {
      return;
    }

    const user_mail = payload.email || payload.sub || null;
    if (!user_mail) return;

    let mounted = true;
    const controller = new AbortController();
    const idle = window.requestIdleCallback || ((cb) => setTimeout(cb, 0));

    idle(() => {
      if (!mounted) return;
      
      // API ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÏÉÅÌÉú ÌôïÏù∏
      const checkServerConnection = async () => {
        try {
          const res = await fetch(
            `http://localhost:8080/api/mypage/user-id?email=${encodeURIComponent(user_mail)}`,
            { signal: controller.signal, headers: { Accept: "application/json" } }
          );
          
          if (res.ok) {
            const data = await res.json();
            if (data && data.user_id != null) {
              const idNum = Number(data.user_id);
              setUserId(idNum);
              sessionStorage.setItem("cached_user_id", String(idNum));
            }
          }
        } catch (err) {
          if (err?.name !== "AbortError") {
            console.log("API ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïã§Ìå® - Ïò§ÌîÑÎùºÏù∏ Î™®ÎìúÎ°ú Ïã§ÌñâÎê©ÎãàÎã§.");
            // Ïò§ÌîÑÎùºÏù∏ Î™®Îìú: Ï∫êÏãúÎêú ÏÇ¨Ïö©Ïûê ID ÏÇ¨Ïö©
            const cached = sessionStorage.getItem("cached_user_id");
            if (cached) {
              setUserId(Number(cached));
            }
          }
        }
      };
      
      checkServerConnection();
    });

    return () => {
      mounted = false;
      controller.abort();
    };
  }, []);

  // ÏΩîÏù∏ id(asset_id) Í∞ÄÏ†∏Ïò§Í∏∞
  async function fetchAssetId(assetSymbol) {
    try {
      const url = `http://localhost:8080/api/Market_assets/asset-id?asset_symbol=${encodeURIComponent(assetSymbol)}`;
      const res = await fetch(url, { headers: { Accept: "application/json" } });
      if (!res.ok) return null;

      const arr = await res.json();
      if (Array.isArray(arr) && arr.length) {
        const n = Number(arr[0]);
        return Number.isFinite(n) ? n : null;
      }
    } catch (err) {
      console.log("API ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïã§Ìå® - asset_id Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®");
      return null;
    }
    return null;
  }




  
  // Îß§Ïàò/Îß§ÎèÑ Ìï∏Îì§Îü¨
  const handleBuy = async () => {
    if (!selectedCoin) {
      return alert("ÏΩîÏù∏ÏùÑ Î®ºÏ†Ä ÏÑ†ÌÉùÌïòÏÑ∏Ïöî!");
    }

    let id = asset_id;
    if (id == null && selectedCoin) {
      const assetSymbol = `${selectedCoin}-KRW`;
      id = await fetchAssetId(assetSymbol);
      setAsset_id(id);
    }

    try {
      const body = {
        user_id: user_id,
        asset_id: id,
        amount: orderQty,
        price: orderPrice,
      };
      alert("handleBuy:Îß§Ïàò body: " + body.user_id + ", " + body.asset_id + ", " + body.amount + ", " + body.price);
      
      await axios.post("http://localhost:8080/api/trade/market_buy", body);
      alert(`${selectedCoin} Îß§Ïàò ÏÑ±Í≥µ!`);
    } catch (err) {
      if (err.code === 'ERR_NETWORK' || err.message.includes('fetch')) {
        alert("API ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§. ÏÑúÎ≤Ñ ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.");
      } else {
        alert("handleBuy:Îß§Ïàò Ïã§Ìå®: " + err.message);
      }
    }
  };



  const handleSell = async () => {
    if (!selectedCoin) {
      return alert("ÏΩîÏù∏ÏùÑ Î®ºÏ†Ä ÏÑ†ÌÉùÌïòÏÑ∏Ïöî!");
    }

    let id = asset_id;
    if (id == null && selectedCoin) {
      const assetSymbol = `${selectedCoin}-KRW`;
      id = await fetchAssetId(assetSymbol);
      setAsset_id(id);
    }

    try {
      const body = {
        user_id: user_id,
        asset_id: id,
        amount: orderQty,
        price: orderPrice,
      };
      alert("handleSell:Îß§ÎèÑ body: " + body.user_id + ", " + body.asset_id + ", " + body.amount + ", " + body.price);
      await axios.post("http://localhost:8080/api/trade/market_sell", body);
      alert(`${selectedCoin} Îß§ÎèÑ ÏÑ±Í≥µ!`);
    } catch (err) {
      if (err.code === 'ERR_NETWORK' || err.message.includes('fetch')) {
        alert("API ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§. ÏÑúÎ≤Ñ ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.");
      } else {
        alert("handleSell:Îß§ÎèÑ Ïã§Ìå®: " + err.message);
      }
    }
  };

  // ÎÜíÏù¥ Í≥ÑÏÇ∞
  useEffect(() => {
    function updateHeight() {
      if (mainPanelRef.current) {
        setCombinedHeight(mainPanelRef.current.offsetHeight);
      }
    }
    updateHeight();
    window.addEventListener('resize', updateHeight);
    const resizeObs = mainPanelRef.current ? new window.ResizeObserver(updateHeight) : null;
    if (resizeObs && mainPanelRef.current) resizeObs.observe(mainPanelRef.current);
    return () => {
      window.removeEventListener('resize', updateHeight);
      if (resizeObs && mainPanelRef.current) resizeObs.disconnect();
    };
  }, []);

  // ÎπóÏç∏ WebSocket Ïó∞Í≤∞
  useEffect(() => {
    console.log('üöÄ ÎπóÏç∏ Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Ïó∞Í≤∞ ÏãúÏûë...');
    let ws;
    let reconnectTimeout;
    let heartbeatInterval;

    const connectWebSocket = () => {
      const wsUrl = 'ws://localhost:8000/api/realtime';
      console.log(`üîå Ïó∞Í≤∞ ÏãúÎèÑ: ${wsUrl}`);

      try {
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          setWsConnected(true);
          console.log('‚úÖ ÎπóÏç∏ Ïã§ÏãúÍ∞Ñ WebSocket Ïó∞Í≤∞ ÏÑ±Í≥µ');
          
          heartbeatInterval = setInterval(() => {
            if (ws.readyState === WebSocket.OPEN) {
              ws.send(JSON.stringify({ type: 'ping' }));
            }
          }, 30000);
        };

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            
            if (data.type === 'ticker' && data.content) {
              const content = data.content;
              
              if (content.tickType && content.tickType !== '24H') return;
              const symbol = content.symbol;
              if (!symbol) return;
        
              const closePrice = parseFloat(content.closePrice);
              const chgRate = parseFloat(content.chgRate);
              const value = parseFloat(content.value || 0);
        
              if (isNaN(closePrice) || isNaN(value) || value <= 0) {
                return;
              }
        
              setRealTimeData(prev => {
                const prevData = prev[symbol];
                const prevPrice = prevData ? parseFloat(prevData.closePrice) : closePrice;
                const priceDirection = closePrice > prevPrice ? 'up' : closePrice < prevPrice ? 'down' : 'same';
                return {
                  ...prev,
                  [symbol]: {
                    symbol: symbol,
                    closePrice: closePrice,
                    chgRate: chgRate,
                    chgAmt: parseFloat(content.chgAmt) || 0,
                    value: value,
                    timestamp: content.timestamp || Date.now(),
                    priceDirection: priceDirection,
                    lastUpdate: Date.now()
                  }
                };
              });
            } else if (data.type === 'orderbook' && data.content) {  // Ïù¥ Î∂ÄÎ∂Ñ Ï∂îÍ∞Ä
              // Ìò∏Í∞Ä Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨
              const { symbol, bids, asks } = data.content;
              if (symbol === selectedCoin + '_KRW') {
                setOrderbook({ bids, asks, timestamp: Date.now() });
              }
            }
          } catch (e) {
            console.error('‚ùå Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ïò§Î•ò:', e);
          }
        };

        ws.onclose = (event) => {
          setWsConnected(false);
          console.log('‚ùå WebSocket Ïó∞Í≤∞ Ï¢ÖÎ£å:', event.code, event.reason);
          
          if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
          }
          
          reconnectTimeout = setTimeout(() => {
            console.log('üîÑ WebSocket Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ...');
            connectWebSocket();
          }, 3000);
        };

        ws.onerror = (error) => {
          console.error('‚ùå WebSocket Ïò§Î•ò:', error);
          setWsConnected(false);
          reconnectTimeout = setTimeout(connectWebSocket, 3000);
        };

      } catch (error) {
        console.error('‚ùå WebSocket ÏÉùÏÑ± Ïò§Î•ò:', error);
        setWsConnected(false);
        reconnectTimeout = setTimeout(connectWebSocket, 3000);
      }
    };

    connectWebSocket();

    return () => {
      if (reconnectTimeout) clearTimeout(reconnectTimeout);
      if (heartbeatInterval) clearInterval(heartbeatInterval);
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.close();
      }
    };
  }, []);

  // WebSocket ÌÜµÍ≥Ñ Í∞ÄÏ†∏Ïò§Í∏∞
  useEffect(() => {
    const fetchStats = async () => {
      try {
        const response = await fetch('http://localhost:8000/api/websocket/stats');
        if (response.ok) {
          const data = await response.json();
          setWsStats(data.subscription_stats || data || {});
        }
      } catch (error) {
        // Ïò§Î•ò Î°úÍ∑∏ Ï†úÍ±∞
      }
    };
    if (wsConnected) {
      fetchStats();
      const interval = setInterval(fetchStats, 30000);
      return () => clearInterval(interval);
    }
  }, [wsConnected]);

  // ÏΩîÏù∏ Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
  useEffect(() => {
    const fetchCoins = async () => {
      try {
        setCoinListLoading(true);
        console.log(`üîÑ ÏõêÌôî ÎßàÏºì ÏΩîÏù∏ Î™©Î°ù ÏöîÏ≤≠...`);
        const apiUrl = 'http://localhost:8000/api/coins';
        const response = await fetch(apiUrl);
        const data = await response.json();
        
        if (data.status === 'success' && data.data && Array.isArray(data.data)) {
          console.log(`‚úÖ ÏõêÌôî ÎßàÏºì ${data.data.length}Í∞ú ÏΩîÏù∏ Î°úÎìú ÏÑ±Í≥µ`);
                     const mappedCoins = data.data.map(coin => ({
             symbol: coin.symbol,
             name: coin.korean_name || coin.symbol,
             englishName: coin.english_name || coin.symbol,
             price: coin.current_price || 0,
             change: coin.change_rate || 0,
             changeAmount: coin.change_amount || 0,
             volume: coin.volume || 0,
             trend: (coin.change_rate || 0) > 0 ? 'up' : 'down',
             marketWarning: coin.market_warning || 'NONE',
             marketCap: coin.market_cap || 0,
             marketCapRank: coin.market_cap_rank || 0,
             // Ï∂îÍ∞Ä Ï†ïÎ≥¥Îì§
             circulatingSupply: coin.circulating_supply || 0,
             high24h: coin.high_24h || 0,
             low24h: coin.low_24h || 0,
             unitsTraded: coin.units_traded || 0
           }));
          setCoinList(mappedCoins);
        }
      } catch (e) {
        console.error(`‚ùå ÏõêÌôî ÎßàÏºì Ï°∞Ìöå Ïã§Ìå®:`, e);
      } finally {
        setCoinListLoading(false);
      }
    };
    fetchCoins();
  }, []);

  // Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞Î°ú ÏΩîÏù∏ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
  const updatedCoinList = useMemo(() => {
    return coinList.map(coin => {
      const realtimeInfo = realTimeData[coin.symbol + '_KRW'];
      if (realtimeInfo && !isNaN(realtimeInfo.closePrice)) {
        const millionValue = Math.round(parseFloat(realtimeInfo.value) / 1000000);
        const formattedVolume = millionValue.toLocaleString() + ' Î∞±Îßå';
        return {
          ...coin,
          price: parseInt(realtimeInfo.closePrice),
          change: parseFloat(realtimeInfo.chgRate),
          changeAmount: parseInt(realtimeInfo.chgAmt),
          trend: parseFloat(realtimeInfo.chgRate) > 0 ? 'up' : 'down',
          volume: formattedVolume
        };
      } else {
        return {
          ...coin,
          price: coin.price || 0,
          change: coin.change || 0,
          changeAmount: coin.changeAmount || 0,
          trend: coin.change > 0 ? 'up' : coin.change < 0 ? 'down' : 'same',
          volume: coin.volume ? `${Math.round(coin.volume / 1000000).toLocaleString()} Î∞±Îßå` : ''
        };
      }
    });
  }, [coinList, realTimeData]);

  // Ï†ïÎ†¨ ÏÉÅÌÉú
  const [sortKey, setSortKey] = useState('volume');
  const [sortOrder, setSortOrder] = useState('desc');

  // Ï†ïÎ†¨ Ìï∏Îì§Îü¨
  const handleSort = (key) => {
    if (sortKey === key) {
      setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');
    } else {
      setSortKey(key);
      setSortOrder('desc');
    }
  };

  // ÌïÑÌÑ∞ÎßÅÎêú ÏΩîÏù∏ Î™©Î°ù
  const filteredCoinList = useMemo(() => {
    let filtered = updatedCoinList;
    if (searchTerm.trim()) {
      const lower = searchTerm.trim().toLowerCase();
      filtered = updatedCoinList.filter(coin =>
        (coin.name && coin.name.toLowerCase().includes(lower)) ||
        (coin.symbol && coin.symbol.toLowerCase().includes(lower))
      );
    }

    const sorted = [...filtered].sort((a, b) => {
      let aValue = a[sortKey];
      let bValue = b[sortKey];
      
      if (sortKey === 'volume') {
        aValue = typeof aValue === 'string' ? parseFloat(aValue.replace(/[^\d.]/g, '')) : aValue;
        bValue = typeof bValue === 'string' ? parseFloat(bValue.replace(/[^\d.]/g, '')) : bValue;
      }
      
      if (typeof aValue === 'string') aValue = aValue.toLowerCase();
      if (typeof bValue === 'string') bValue = bValue.toLowerCase();
      if (aValue === undefined) return 1;
      if (bValue === undefined) return -1;
      
      if (sortOrder === 'asc') {
        if (aValue < bValue) return -1;
        if (aValue > bValue) return 1;
        return 0;
      } else {
        if (aValue > bValue) return -1;
        if (aValue < bValue) return 1;
        return 0;
      }
    });
    return sorted;
  }, [searchTerm, updatedCoinList, sortKey, sortOrder]);

  // ÌòÑÏû¨Í∞Ä Í≥ÑÏÇ∞
  const currentPriceKRW = useMemo(() => {
    const rt = realTimeData[selectedCoin + "_KRW"];
    if (rt?.closePrice) return parseInt(rt.closePrice, 10);
    const fallback = updatedCoinList.find(c => c.symbol === selectedCoin)?.price;
    return typeof fallback === "number" ? fallback : 0;
  }, [selectedCoin, realTimeData, updatedCoinList]);

  // Ï£ºÎ¨∏Í∞ÄÍ≤©ÏùÑ ÌòÑÏû¨Í∞ÄÎ°ú ÎèôÍ∏∞Ìôî
  useEffect(() => {
    setOrderPrice(currentPriceKRW);
  }, [currentPriceKRW, selectedCoin]);


  // orderbook Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
  useEffect(() => {
    if (!selectedCoin) return;
    
    const fetchOrderbook = async () => {
      try {
        const response = await fetch(`http://localhost:8000/api/orderbook/${selectedCoin}_KRW`);
        if (response.ok) {
          const data = await response.json();
          setOrderbook(data);
        }
      } catch (error) {
        console.error('Ìò∏Í∞Ä Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:', error);
      }
    };

    // Ï¥àÍ∏∞ Î°úÎìú
    fetchOrderbook();
    
    // Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏ (3Ï¥àÎßàÎã§)
    const interval = setInterval(fetchOrderbook, 3000);
    
    return () => clearInterval(interval);
  }, [selectedCoin]);

  // ÏΩîÏù∏ ÏÑ†ÌÉù Ïãú ÏÉÅÏÑ∏ ÌôîÎ©¥ÏúºÎ°ú Ï†ÑÌôò
  const handleCoinSelect = async (coin) => {
    setSelectedCoin(coin.symbol);
    const market = "KRW";
    const assetSymbol = `${coin.symbol}-${market}`;
    const id = await fetchAssetId(assetSymbol);
    setAsset_id(id);
    setView("detail");
    setDetailView("chart");
  };

  return (
    <div className="w-full p-0 space-y-4">

        {/* Ïó∞Í≤∞ ÏÉÅÌÉú ÌëúÏãú */}
        <div className="flex items-center justify-between bg-gray-100 p-3 rounded-lg mb-4">
        <div className="flex items-center gap-2">
            <span className={`text-sm font-semibold ${wsConnected ? 'text-green-600' : 'text-red-600'}`}>
            {wsConnected ? 'üü¢ Í±∞ÎûòÏÜå Ïã§ÏãúÍ∞Ñ Ïó∞Í≤∞Îê®' : 'üî¥ Ïó∞Í≤∞ ÎÅäÏñ¥Ïßê'}
            </span>
            <span className="text-sm text-gray-500">
            Ïã§ÏãúÍ∞Ñ: {Object.keys(realTimeData).length}Í∞ú | 
            Ï¥ù ÏΩîÏù∏: {coinList.length}Í∞ú
            </span>
        </div>
        <div className="text-sm text-gray-500">
            ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏: {new Date().toLocaleTimeString()}
        </div>
        </div>

      {/* ÏÉÅÏÑ∏ Í±∞Îûò ÌôîÎ©¥ */}
        <div className="w-full">       
          {/* ÏÉÅÎã® Ìó§Îçî - Îí§Î°úÍ∞ÄÍ∏∞ Î≤ÑÌäº Ìè¨Ìï® */}
          <div className="flex items-center justify-between mb-4">
            <div className="w-2/5 flex justify-center">
              <div className="text-4xl font-bold">
                <span>Ï¢ÖÎ™©(ÏÉÅÌíà)</span>
              </div>
            </div>
          </div>

          {/* Ï¢åÏ∏°: ÏΩîÏù∏ Î™©Î°ù (2/5) */}
          <div className="flex flex-row min-h-0" style={{ height: combinedHeight }}>
            
            {/* ÏΩîÏù∏Î™©Î°ù */}
            <div className="flex flex-col w-2/5 min-h-0" style={{ height: 600 }}>
              <Card className="flex flex-col border-0" style={{ height: 1200 }}>
                <CardHeader className="pb-2">
                  <div className="flex items-center gap-2.5 mb-2">
                    <Search className="h-4 w-4 text-muted-foreground" />
                    <input
                      placeholder="ÏΩîÏù∏Î™Ö/Ïã¨Î≥ºÍ≤ÄÏÉâ"
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className="h-10 flex-1 border rounded px-2"
                      autoComplete="off"
                    />
                  </div>
                  
                  {/* ÏõêÌôî/Î≥¥Ïú†/Í¥ÄÏã¨ ÌÉ≠ */}
                  <div className="flex bg-gray-100 rounded-lg p-1 w-full mb-4 shadow-sm">
                    {[
                      { key: "won", label: "ÏõêÌôî" },
                      { key: "hold", label: "Î≥¥Ïú†" },
                      { key: "star", label: "Í¥ÄÏã¨" },
                    ].map((t, i) => (
                      <button
                        key={t.key}
                        onClick={() => setTab(t.key)}
                        className={`flex-1 py-2 px-3 text-center text-sm font-medium transition-all duration-200 rounded-md flex flex-col justify-end
                          ${t.key === tab
                            ? "bg-white text-gray-800 shadow-sm font-semibold"
                            : "text-gray-500 hover:text-gray-700"}
                          ${i === 0 ? "rounded-l-md" : ""} ${i === 2 ? "rounded-r-md" : ""}`}
                        style={{ minWidth: 0 }}
                      >
                        {t.label}
                      </button>
                    ))}
                  </div>
                </CardHeader>
                <CardContent className="p-0 flex-1 flex flex-col min-h-0" style={{ height: 600 }}>
                  {/* Ïª¨Îüº Ìó§Îçî */}
                  <div className="grid grid-cols-[auto_1fr_1fr_1fr_1fr] gap-6 px-2 py-2 text-sm font-bold text-muted-foreground border-b bg-gray-50 sticky top-0 z-10" style={{ 
                    height: '40px', 
                    minHeight: '40px', 
                    maxHeight: '40px',
                    flexShrink: 0,
                    overflow: 'hidden'
                  }}>
                    <div className="text-center gap-3" style={{ lineHeight: '1', verticalAlign: 'baseline' }}>
                      {/* Í¥ÄÏã¨ Î≥Ñ ÏïÑÏù¥ÏΩò */}
                    </div>
                    <div className="flex items-center cursor-pointer text-left" onClick={() => handleSort('name')} style={{ lineHeight: '1', verticalAlign: 'baseline' }}>
                      ÌïúÍ∏ÄÎ™Ö
                      {sortKey === 'name' ? (
                        <span className="text-[10px] text-blue-600" style={{ lineHeight: '1', verticalAlign: 'baseline' }}>{sortOrder === 'asc' ? '‚ñ≤' : '‚ñº'}</span>
                      ) : (
                        <span className="text-[10px] text-gray-300" style={{ lineHeight: '1', verticalAlign: 'baseline' }}>‚ñ≥‚ñΩ</span>
                      )}
                    </div>
                    <div className="text-right flex items-center gap-1 cursor-pointer" onClick={() => handleSort('price')}>
                      ÌòÑÏû¨Í∞Ä
                      {sortKey === 'price' ? (
                        <span className="text-[10px] text-blue-600">{sortOrder === 'asc' ? '‚ñ≤' : '‚ñº'}</span>
                      ) : (
                        <span className="text-[10px] text-gray-300">‚ñ≥‚ñΩ</span>
                      )}
                    </div>
                    <div className="text-right flex items-center gap-1 cursor-pointer" onClick={() => handleSort('change')}>
                      Ï†ÑÏùºÎåÄÎπÑ
                      {sortKey === 'change' ? (
                        <span className="text-[10px] text-blue-600">{sortOrder === 'asc' ? '‚ñ≤' : '‚ñº'}</span>
                      ) : (
                        <span className="text-[10px] text-gray-300">‚ñ≥‚ñΩ</span>
                      )}
                    </div>
                    <div className="text-right flex items-center gap-1 cursor-pointer" onClick={() => handleSort('volume')}>
                      Í±∞ÎûòÎåÄÍ∏à
                      {sortKey === 'volume' ? (
                        <span className="text-[10px] text-blue-600">{sortOrder === 'asc' ? '‚ñ≤' : '‚ñº'}</span>
                      ) : (
                        <span className="text-[10px] text-gray-300">‚ñ≥‚ñΩ</span>
                      )}
                    </div>
                  </div>
                  <div className="overflow-y-auto flex-1 min-h-0" style={{ 
                    height: combinedHeight,
                    flexShrink: 0
                  }}>
                    {coinListLoading ? (
                      <div className="p-4 text-center text-gray-500">Î°úÎî© Ï§ë...</div>
                    ) : filteredCoinList.length === 0 ? (
                      <div className="p-4 text-center text-gray-500">ÏΩîÏù∏ Î™©Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</div>
                    ) : (
                      filteredCoinList.map((coin, index) => (
                        <div
                          key={coin.symbol}
                          onClick={() => handleCoinSelect(coin)}
                          className={`grid grid-cols-[auto_1fr_1fr_1fr_1fr] gap-3 p-1 text-sm cursor-pointer border-b items-center
                            ${selectedCoin === coin.symbol ? 'bg-blue-50 border-blue-200' : ''}`}
                          style={{ 
                            height: '48px', 
                            minHeight: '48px', 
                            maxHeight: '48px',
                            flexShrink: 0,
                            overflow: 'hidden'
                          }}
                        >
                          {/* Í¥ÄÏã¨ Î≥Ñ ÏïÑÏù¥ÏΩò */}
                          <div className="flex justify-center items-center" style={{ 
                            height: '100%',
                            flexShrink: 0,
                            overflow: 'hidden'
                          }}>
                            <button
                              onClick={(e) => toggleFavorite(coin.symbol, e)}
                              className="p-1 hover:bg-gray-100 rounded transition-colors"
                            >
                              <StarIcon 
                                filled={favoriteCoins.has(coin.symbol)} 
                                size={18}
                                className={favoriteCoins.has(coin.symbol) ? "text-yellow-500" : "text-gray-400"}
                              />
                            </button>
                          </div>
                          {/* ÌïúÍ∏ÄÎ™Ö/Ïã¨Î≥º */}
                          <div className="flex items-center gap-1 text-left" style={{ 
                            height: '100%',
                            flexShrink: 0,
                            overflow: 'hidden'
                          }}>
                            <div className="flex flex-col justify-center" style={{ width: '100%' }}>
                              <div
                                className={`font-semibold text-sm ${selectedCoin === coin.symbol ? 'text-black dark:text-black' : ''}`}
                                style={{ lineHeight: '1.2', verticalAlign: 'baseline' }}
                              >
                                {coin.name}
                                {realTimeData[coin.symbol + '_KRW'] && (
                                  <span className="ml-1 text-green-500 text-[8px]" style={{ lineHeight: '1', verticalAlign: 'baseline' }}>‚óè</span>
                                )}
                              </div>
                              <div className="text-muted-foreground text-sm" style={{ lineHeight: '1.2', verticalAlign: 'baseline' }}>{coin.symbol}/KRW</div>
                            </div>
                          </div>
                          {/* ÌòÑÏû¨Í∞Ä */}
                          <div
                            className={`text-right font-mono font-semibold text-lg flex items-center justify-end ${selectedCoin === coin.symbol ? 'text-black dark:text-black' : ''}`}
                            style={{ 
                              height: '100%',
                              flexShrink: 0,
                              overflow: 'hidden'
                            }}
                          >
                            <span style={{ lineHeight: '1', verticalAlign: 'baseline' }}>
                              {(() => {
                                const realtime = realTimeData[coin.symbol + '_KRW']?.closePrice;
                                let price = typeof realtime !== 'undefined' ? Number(realtime) : coin.price;
                                if (typeof price !== 'number' || isNaN(price)) price = 0;
                                if (price < 10) {
                                  return price.toLocaleString(undefined, { minimumFractionDigits: 4, maximumFractionDigits: 8 });
                                } else if (price < 100) {
                                  return price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                                } else {
                                  return Math.floor(price).toLocaleString();
                                }
                              })()}
                            </span>
                          </div>
                          {/* Ï†ÑÏùºÎåÄÎπÑ */}
                          <div className={`text-right font-semibold flex flex-col justify-center ${coin.trend === 'up' ? 'text-red-600' : 'text-blue-600'}`} style={{ 
                            height: '100%',
                            flexShrink: 0,
                            overflow: 'hidden'
                          }}>
                            <div style={{ lineHeight: '1.2', verticalAlign: 'baseline' }}>{coin.trend === 'up' ? '+' : ''}{coin.change !== 0 ? coin.change.toFixed(2) : '0.00'}%</div>
                            <div className="text-sm" style={{ lineHeight: '1.2', verticalAlign: 'baseline' }}>
                              {coin.changeAmount > 0 ? '+' : ''}
                              {coin.changeAmount !== 0 ? coin.changeAmount.toLocaleString() : '0'}
                            </div>
                          </div>
                          {/* Í±∞ÎûòÎåÄÍ∏à */}
                          <div
                            className={`text-right text-sm flex items-center justify-end ${selectedCoin === coin.symbol ? 'text-black dark:text-black' : ''}`}
                            style={{ 
                              height: '100%',
                              flexShrink: 0,
                              overflow: 'hidden'
                            }}
                          >
                            <span style={{ lineHeight: '1', verticalAlign: 'baseline' }}>
                              {coin.volume !== '' ? coin.volume : '-'}
                            </span>
                          </div>
                        </div>
                      ))
                    )}
                  </div>
                </CardContent>
              </Card>
            </div>

            {/* Ïö∞Ï∏°: Ï∞®Ìä∏ Î∞è Í±∞Îûò ÏòÅÏó≠ (3/5) */}
            <div className="flex flex-col min-h-0 gap-4 h-full w-3/5" ref={mainPanelRef}>
              {/* Ï∞®Ìä∏ or ÏΩîÏù∏Ï†ïÎ≥¥ */}
              <div className="w-full" style={{ 
                height: chartPanelExpanded ? combinedHeight : '120px' 
              }}>
                {/* Ï∞®Ìä∏/ÏΩîÏù∏Ï†ïÎ≥¥ ÌÉ≠Ìå¨ */}
                <div className={`flex justify-left border-b border-gray-200 ${
                  chartPanelExpanded ? 'mb-4' : 'mb-1'
                }`}>
                  <button
                    className={`w-32 px-6 py-3 text-xl font-semibold text-center border-2 border-gray-300 rounded-t-lg hover:bg-gray-50 transition-colors ${
                      chartPanelExpanded && chartTab === "Ï∞®Ìä∏" 
                        ? 'text-blue-600 border-blue-500 bg-blue-100' 
                        : 'text-gray-500 bg-white'
                    }`}
                    onClick={() => {
                      if (chartPanelExpanded && chartTab === "Ï∞®Ìä∏") {
                        setChartPanelExpanded(false);
                      } else {
                        setChartPanelExpanded(true);
                        setChartTab("Ï∞®Ìä∏");
                      }
                    }}
                  >
                    Ï∞®Ìä∏
                  </button>
                  <button
                    className={`w-30 px-6 py-3 text-xl font-semibold text-center border-2 border-gray-300 rounded-t-lg hover:bg-gray-50 transition-colors border-l-0 rounded-l-none ${
                      chartPanelExpanded && chartTab === "ÏΩîÏù∏Ï†ïÎ≥¥" 
                        ? 'text-blue-600 border-blue-500 bg-blue-100' 
                        : 'text-gray-500 bg-white'
                    }`}
                    onClick={() => {
                      if (chartPanelExpanded && chartTab === "ÏΩîÏù∏Ï†ïÎ≥¥") {
                        setChartPanelExpanded(false);
                      } else {
                        setChartPanelExpanded(true);
                        setChartTab("ÏΩîÏù∏Ï†ïÎ≥¥");
                      }
                    }}
                  >
                    ÏΩîÏù∏Ï†ïÎ≥¥
                  </button>
                </div>
                
                {/* Ï∞®Ìä∏ ÎÇ¥Ïö© (ÏïÑÏΩîÎîîÏñ∏) */}
                {chartPanelExpanded && chartTab === "Ï∞®Ìä∏" && (
                  <div className="p-2" style={{ height: '550px' }}>
                    {/* Ï∞®Ìä∏ ÏòÅÏó≠ */}
                    <div className="bg-white rounded h-full">
                      <TradingChart 
                        symbol={`${selectedCoin}/KRW`}
                        koreanName={selectedCoin === "BTC" ? "ÎπÑÌä∏ÏΩîÏù∏" : selectedCoin}
                        height={650}
                        theme="light"
                        currentPrice={realTimeData[selectedCoin]?.close_price || 0}
                        initialTimeframe="1h"
                        onPriceUpdate={(price) => {
                          // Ïã§ÏãúÍ∞Ñ Í∞ÄÍ≤© ÏóÖÎç∞Ïù¥Ìä∏
                          if (price > 0) {
                            setRealTimeData(prev => ({
                              ...prev,
                              [selectedCoin]: {
                                ...prev[selectedCoin],
                                close_price: price
                              }
                            }));
                          }
                        }}
                      />
                    </div>
                  </div>
                )}
                
                {/* ÏΩîÏù∏Ï†ïÎ≥¥ ÎÇ¥Ïö© (ÏïÑÏΩîÎîîÏñ∏) */}
                {chartPanelExpanded && chartTab === "ÏΩîÏù∏Ï†ïÎ≥¥" && (
                  <div className="p-4 " style={{ height: '900px' }}>
                    {/* CoinInfoPanel Ïª¥Ìè¨ÎÑåÌä∏ ÏÇ¨Ïö© */}
                    <CoinInfoPanel 
                      coin={coinList.find(c => c.symbol === selectedCoin) || coinList[0]} 
                      realTimeData={realTimeData[selectedCoin + '_KRW']}
                      marketCap={coinList.find(c => c.symbol === selectedCoin)?.marketCap || 0}
                    />
                  </div>
                )}            
              
              {/* ÌïòÎã®: Ïò§ÎçîÎ∂Å/Ï†ïÎ≥¥Ìå®ÎÑê/Ï£ºÎ¨∏ */}
              {detailView === "chart" && (
                <div className="w-full flex flex-row" style={{ 
                  height: chartPanelExpanded ? 600 : 800, 
                  marginTop: chartPanelExpanded ? '170px' : '20px' 
                }}>
                  
                  {/* Ï£ºÎ¨∏ ÏòÅÏó≠ (2/5) */}
                  <div className="flex-1 w-2/3 flex flex-col bg-white px-6 overflow-auto" 
                  style={{
                    minHeight: '800px',
                    paddingTop: chartPanelExpanded ? '16px' : '28px',
                    paddingBottom: '0'
                  }}>
                    {/* Î©îÏù∏ ÌÉ≠ Ìó§Îçî */}
                    <div className="flex justify-center border-b border-gray-200 mb-4">
                        <button 
                          className={`w-full px-6 py-3 text-3xl font-semibold text-center border-2 border-gray-300 rounded-t-lg transition-colors ${
                            orderPanelExpanded 
                              ? 'text-blue-600 border-blue-500 bg-blue-50' 
                              : 'text-gray-500 bg-white hover:bg-gray-50'
                          }`}
                          onClick={() => setOrderPanelExpanded(!orderPanelExpanded)}
                        >
                            Í±∞Îûò
                        </button>
                    </div>
                    
                    {/* Ï£ºÎ¨∏Ï∞Ω ÏïÑÏΩîÎîîÏñ∏ */}
                    {orderPanelExpanded && (
                      <div className="w-4/5 mx-auto">

                    {/* Í±∞Îûò ÌÉ≠Ïùº ÎïåÎßå ÏÑúÎ∏å ÌÉ≠ ÌëúÏãú */}
                    {orderTab === "Í±∞Îûò" && (
                      <div className="flex border-b border-gray-200 mb-4">
                        {["Îß§Ïàò", "Îß§ÎèÑ", "Í±∞ÎûòÎÇ¥Ïó≠"].map((t) => {
                          let activeClass = "";
                          if (tradeSubTab === t) {
                            if (t === "Îß§Ïàò") activeClass = "border-b-2 border-red-500 text-red-600 font-semibold";
                            else if (t === "Îß§ÎèÑ") activeClass = "border-b-2 border-blue-500 text-blue-600 font-semibold";
                            else if (t === "Í±∞ÎûòÎÇ¥Ïó≠") activeClass = "border-b-2 border-black text-black font-semibold";
                          } else {
                            activeClass = "text-gray-500";
                          }
                          return (
                            <button
                              key={t}
                              className={`flex-1 py-2 text-lg ${activeClass}`}
                              onClick={() => setTradeSubTab(t)}
                            >
                              {t}
                            </button>
                          );
                        })}
                      </div>
                    )}

                    {/* Îß§Ïàò/Îß§ÎèÑ ÌÉ≠ Í≥µÌÜµ */}
                    {orderTab === "Í±∞Îûò" && (tradeSubTab === "Îß§Ïàò" || tradeSubTab === "Îß§ÎèÑ") ? (
                      <>
                        {/* Ï£ºÎ¨∏Ïú†Ìòï */}
                        <div className="flex items-center gap-4 mb-6">
                          <span className="text-md font-semibold">Ï£ºÎ¨∏Ïú†Ìòï</span>
                          <label className="flex items-center gap-1 text-md font-semibold text-blue-600">
                            <input type="radio" name="orderType" defaultChecked className="accent-blue-500" /> ÏßÄÏ†ïÍ∞Ä
                          </label>
                          <label className="flex items-center gap-1 text-md text-gray-400">
                            <input type="radio" name="orderType" className="accent-blue-500" /> ÏãúÏû•Í∞Ä
                          </label>
                        </div>

                        {/* Í∞ÄÍ≤© */}
                        <div className="flex items-center justify-between mb-1">
                          <span className="text-md font-semibold">
                            {tradeSubTab === "Îß§Ïàò" ? "Îß§ÏàòÍ∞ÄÍ≤© (KRW)" : "Îß§ÎèÑÍ∞ÄÍ≤© (KRW)"}
                          </span>
                          <div className="text-sm text-gray-500 bg-gray-100 px-2 py-1 rounded">
                            ÌòÑÏû¨Í∞Ä {(() => {
                              const realtime = realTimeData[selectedCoin + '_KRW']?.closePrice;
                              let price = typeof realtime !== 'undefined' ? Number(realtime) : currentPriceKRW;
                              if (typeof price !== 'number' || isNaN(price)) price = 0;
                              if (price < 10) {
                                return price.toLocaleString(undefined, { minimumFractionDigits: 4, maximumFractionDigits: 8 });
                              } else if (price < 100) {
                                return price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                              } else {
                                return Math.floor(price).toLocaleString();
                              }
                            })()} KRW
                          </div>
                        </div>
                        <input
                          type="text"
                          value={(() => {
                            const realtime = realTimeData[selectedCoin + '_KRW']?.closePrice;
                            let price = typeof realtime !== 'undefined' ? Number(realtime) : orderPrice;
                            if (typeof price !== 'number' || isNaN(price)) price = 0;
                            if (price < 10) {
                              return price.toLocaleString(undefined, { minimumFractionDigits: 4, maximumFractionDigits: 8 });
                            } else if (price < 100) {
                              return price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                            } else {
                              return Math.floor(price).toLocaleString();
                            }
                          })()}
                          onChange={(e) => setOrderPrice(Number(e.target.value) || 0)}
                          className="w-full border rounded h-16 px-2 mb-6 text-3xl font-semibold"
                          placeholder="0"
                        />

                        {/* ÏàòÎüâ */}
                        <div className="mb-6">
                          <div className="text-md font-semibold mb-1">Ï£ºÎ¨∏ÏàòÎüâ</div>
                          <input
                            type="text"
                            value={orderQty}
                            onChange={(e) => setOrderQty(Number(e.target.value) || 0)}
                            className="w-full border rounded h-16 px-2 mb-2 text-3xl font-semibold"
                            placeholder="0"
                          />
                          <div className="flex gap-2">
                            <button className="flex-1 border rounded py-1 text-md" onClick={() => setOrderQty(prev => prev + 0.1)}>+0.1</button>
                            <button className="flex-1 border rounded py-1 text-md" onClick={() => setOrderQty(prev => prev + 0.25)}>+0.25</button>
                            <button className="flex-1 border rounded py-1 text-md" onClick={() => setOrderQty(prev => prev + 0.5)}>+0.5</button>
                            <button className="flex-1 border rounded py-1 text-md" onClick={() => setOrderQty(0)}>Ï¥àÍ∏∞Ìôî</button>
                          </div>
                        </div>

                        {/* Ï¥ùÏï° */}
                        <div className="mb-6">
                          <div className="text-md font-semibold mb-1">Ï£ºÎ¨∏Ï¥ùÏï° (KRW)</div>
                          <input
                            type="text"
                            readOnly
                            value={(() => {
                              const realtime = realTimeData[selectedCoin + '_KRW']?.closePrice;
                              let price = typeof realtime !== 'undefined' ? Number(realtime) : orderPrice;
                              if (typeof price !== 'number' || isNaN(price)) price = 0;
                              const totalAmount = price * (orderQty || 0);
                              if (totalAmount < 10) {
                                return totalAmount.toLocaleString(undefined, { minimumFractionDigits: 4, maximumFractionDigits: 8 });
                              } else if (totalAmount < 100) {
                                return totalAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                              } else {
                                return totalAmount.toLocaleString();
                              }
                            })()}
                            className="w-full border rounded h-16 px-2 bg-gray-50 text-3xl font-semibold"
                            placeholder="0"
                          />
                        </div>

                        {/* Îß§Ïàò/Îß§ÎèÑ Î≤ÑÌäº */}
                        {tradeSubTab === "Îß§Ïàò" && (
                          <button
                            className="w-full h-20 rounded-md bg-red-600 text-white text-2xl font-semibold hover:opacity-90"
                            type="button"
                            onClick={handleBuy}
                          >
                            Îß§Ïàò
                          </button>
                        )}
                        {tradeSubTab === "Îß§ÎèÑ" && (
                          <button
                            className="w-full h-20 rounded-md bg-blue-600 text-white text-2xl font-semibold hover:opacity-90"
                            type="button"
                            onClick={handleSell}
                          >
                            Îß§ÎèÑ
                          </button>
                        )}
                      </>
                    ) : null}

                    {/* Í±∞ÎûòÎÇ¥Ïó≠ */}
                    {orderTab === "Í±∞Îûò" && tradeSubTab === "Í±∞ÎûòÎÇ¥Ïó≠" && (
                      <div className="text-md">
                        <div className="flex justify-between items-center mb-3">
                          <div className="flex gap-2">
                            <button
                              type="button"
                              className={`px-3 py-1 rounded-md border text-md ${
                                historyTab === "ÎØ∏Ï≤¥Í≤∞"
                                  ? "bg-blue-50 text-blue-600 border-blue-200"
                                  : "text-gray-600 border-gray-200"
                              }`}
                              onClick={() => setHistoryTab("ÎØ∏Ï≤¥Í≤∞")}
                            >
                              ÎØ∏Ï≤¥Í≤∞
                            </button>
                            <button
                              type="button"
                              className={`px-3 py-1 rounded-md border text-md ${
                                historyTab === "Ï≤¥Í≤∞"
                                  ? "bg-blue-50 text-blue-600 border-blue-200"
                                  : "text-gray-600 border-gray-200"
                              }`}
                              onClick={() => setHistoryTab("Ï≤¥Í≤∞")}
                            >
                              Ï≤¥Í≤∞
                            </button>
                          </div>
                          {historyTab === "ÎØ∏Ï≤¥Í≤∞" && (
                            <button
                              type="button"
                              className="px-3 py-1 rounded-md border text-md bg-red-50 text-red-600 border-red-200 hover:bg-red-100"
                            >
                              ÏÇ≠Ï†ú
                            </button>
                          )}
                        </div>
                        <div className="border rounded p-4 text-center text-gray-400">
                          Í±∞ÎûòÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.
                        </div>
                      </div>
                    )}
                      </div>
                    )}
                  </div>
                  
                  {/* Ìò∏Í∞ÄÏ∞Ω & Í±∞ÎûòÏ†ïÎ≥¥ ÏòÅÏó≠ (1/5) */}
                  <div className="w-1/3 flex flex-col bg-white pt-7">
                    {/* Ìò∏Í∞ÄÏ∞Ω ÏïÑÏΩîÎîîÏñ∏ */}
                    <div className="border-b border-gray-200">
                      <button 
                        className={`w-full px-6 py-3 text-3xl font-semibold text-center border-2 border-gray-300 rounded-t-lg bg-white hover:bg-gray-50 transition-colors ${
                          expandedSections.Ìò∏Í∞Ä ? 'text-blue-600 border-blue-500 bg-blue-50' : 'text-gray-500'
                        }`}
                        onClick={() => toggleSection("Ìò∏Í∞Ä")}
                      >
                        Ìò∏Í∞Ä
                      </button>
                      
                      {/* Ìò∏Í∞ÄÏ∞Ω ÎÇ¥Ïö© (ÏïÑÏΩîÎîîÏñ∏) */}
                      {expandedSections.Ìò∏Í∞Ä && (
                        <div className="p-4 border-t border-gray-200 bg-gray-50">
                          <OrderBook 
                            selectedCoin={selectedCoin}
                            realTimeData={realTimeData[selectedCoin + '_KRW']}
                            orderbook={orderbook}
                            tickSize={tickSize}
                            currentPriceKRW={currentPriceKRW}
                            onPriceSelect={(price) => setOrderPrice(price)}
                          />
                        </div>
                      )}
                    </div>
                    
                    {/* Í±∞ÎûòÏ†ïÎ≥¥ ÏïÑÏΩîÎîîÏñ∏ */}
                    <div className="border-b border-gray-200">
                      <button 
                        className={`w-full px-6 py-3 text-3xl font-semibold text-center border-2 border-gray-300 rounded-t-lg bg-white hover:bg-gray-50 transition-colors ${
                          expandedSections.Í±∞ÎûòÏ†ïÎ≥¥ ? 'text-blue-600 border-blue-500 bg-blue-50' : 'text-gray-500'
                        }`}
                        onClick={() => toggleSection("Í±∞ÎûòÏ†ïÎ≥¥")}
                      >
                        Í±∞ÎûòÏ†ïÎ≥¥
                      </button>
                      
                      {/* Í±∞ÎûòÏ†ïÎ≥¥ ÎÇ¥Ïö© (ÏïÑÏΩîÎîîÏñ∏) */}
                      {expandedSections.Í±∞ÎûòÏ†ïÎ≥¥ && (
                        <div className="p-4 border-t border-gray-200 bg-gray-50">
                          <div className="space-y-3">
                            {/* Í±∞ÎûòÏ†ïÎ≥¥ ÎÇ¥Ïö© */}
                            <div className="text-sm">
                              {/* Í±∞ÎûòÎüâ */}
                              <div className="flex justify-between items-center mb-2">
                                <span className="font-semibold text-gray-700">Í±∞ÎûòÎüâ</span>
                                <span className="text-gray-600">
                                  {(() => {
                                    // coinListÏóêÏÑú unitsTraded (Í±∞ÎûòÎüâ) Í∞ÄÏ†∏Ïò§Í∏∞
                                    const coin = coinList.find(c => c.symbol === selectedCoin);
                                    if (coin?.unitsTraded && coin.unitsTraded > 0) {
                                      const volume = coin.unitsTraded;
                                      // Ï†ÅÏ†àÌïú Îã®ÏúÑÎ°ú Î≥ÄÌôò
                                      if (volume >= 1000000) {
                                        return (volume / 1000000).toFixed(2) + ' M';
                                      } else if (volume >= 1000) {
                                        return (volume / 1000).toFixed(2) + ' K';
                                      } else {
                                        return volume.toLocaleString();
                                      }
                                    }
                                    // Î∞±ÏóÖ: realTimeDataÏóêÏÑú volume ÌôïÏù∏
                                    const rt = realTimeData[selectedCoin + '_KRW'];
                                    if (rt?.volume) {
                                      const volume = rt.volume;
                                      if (volume >= 1000000) {
                                        return (volume / 1000000).toFixed(2) + ' M';
                                      } else if (volume >= 1000) {
                                        return (volume / 1000).toFixed(2) + ' K';
                                      } else {
                                        return volume.toLocaleString();
                                      }
                                    }
                                    return '-';
                                  })()}
                                </span>
                              </div>
                              
                              {/* Í±∞ÎûòÎåÄÍ∏à */}
                              <div className="flex justify-between items-center mb-2">
                                <span className="font-semibold text-gray-700">Í±∞ÎûòÎåÄÍ∏à</span>
                                <span className="text-gray-600">
                                  {(() => {
                                    const rt = realTimeData[selectedCoin + '_KRW'];
                                    if (rt?.value) {
                                      return parseInt(rt.value).toLocaleString();
                                    }
                                    return '-';
                                  })()}
                                </span>
                              </div>
                              <div className="text-xs text-gray-400 mb-3">(ÏµúÍ∑º24ÏãúÍ∞Ñ)</div>
                              
                              {/* 24h ÏµúÍ≥†Í∞Ä */}
                              <div className="flex justify-between items-center mb-2">
                                <span className="font-semibold text-gray-700">24h ÏµúÍ≥†</span>
                                <span className="text-red-500">
                                  {(() => {
                                    const coin = coinList.find(c => c.symbol === selectedCoin);
                                    if (coin?.high24h) {
                                      return coin.high24h.toLocaleString();
                                    }
                                    const rt = realTimeData[selectedCoin + '_KRW'];
                                    if (rt?.highPrice) {
                                      return rt.highPrice.toLocaleString();
                                    }
                                    // ÌòÑÏû¨Í∞Ä Í∏∞Ï§ÄÏúºÎ°ú Ï∂îÏ†ï (Ïã§Ï†úÎ°úÎäî APIÏóêÏÑú Î∞õÏïÑÏôÄÏïº Ìï®)
                                    if (rt?.closePrice && rt?.chgRate) {
                                      const estimatedHigh = rt.closePrice * (1 + Math.abs(rt.chgRate) / 100);
                                      return Math.round(estimatedHigh).toLocaleString();
                                    }
                                    return '-';
                                  })()}
                                </span>
                              </div>
                              
                              {/* 24h ÏµúÏ†ÄÍ∞Ä */}
                              <div className="flex justify-between items-center mb-2">
                                <span className="font-semibold text-gray-700">24h ÏµúÏ†Ä</span>
                                <span className="text-blue-500">
                                  {(() => {
                                    const coin = coinList.find(c => c.symbol === selectedCoin);
                                    if (coin?.low24h) {
                                      return coin.low24h.toLocaleString();
                                    }
                                    const rt = realTimeData[selectedCoin + '_KRW'];
                                    if (rt?.lowPrice) {
                                      return rt.lowPrice.toLocaleString();
                                    }
                                    // ÌòÑÏû¨Í∞Ä Í∏∞Ï§ÄÏúºÎ°ú Ï∂îÏ†ï (Ïã§Ï†úÎ°úÎäî APIÏóêÏÑú Î∞õÏïÑÏôÄÏïº Ìï®)
                                    if (rt?.closePrice && rt?.chgRate) {
                                      const estimatedLow = rt.closePrice * (1 - Math.abs(rt.chgRate) / 100);
                                      return Math.round(estimatedLow).toLocaleString();
                                    }
                                    return '-';
                                  })()}
                                </span>
                              </div>
                              
                              {/* ÏãúÍ∞ÄÏ¥ùÏï° */}
                              <div className="flex justify-between items-center mb-2">
                                <span className="font-semibold text-gray-700">ÏãúÍ∞ÄÏ¥ùÏï°</span>
                                <span className="text-gray-600">
                                  {(() => {
                                    const coin = coinList.find(c => c.symbol === selectedCoin);
                                    if (coin?.marketCap && coin.marketCap > 0) {
                                      if (coin.marketCap >= 1000000000) {
                                        return (coin.marketCap / 1000000000).toFixed(2) + ' B';
                                      } else if (coin.marketCap >= 1000000) {
                                        return (coin.marketCap / 1000000).toFixed(1) + ' M';
                                      } else if (coin.marketCap >= 1000) {
                                        return (coin.marketCap / 1000).toFixed(1) + ' K';
                                      } else {
                                        return coin.marketCap.toLocaleString();
                                      }
                                    }
                                    return '-';
                                  })()}
                                </span>
                              </div>
                              
                              {/* Ïú†ÌÜµÎüâ */}
                              <div className="flex justify-between items-center mb-2">
                                <span className="font-semibold text-gray-700">Ïú†ÌÜµÎüâ</span>
                                <span className="text-gray-600">
                                  {(() => {
                                    const coin = coinList.find(c => c.symbol === selectedCoin);
                                    if (coin?.circulatingSupply && coin.circulatingSupply > 0) {
                                      const supply = coin.circulatingSupply;
                                      // Ï†ïÌôïÌïú Îã®ÏúÑ Î≥ÄÌôò Î∞è ÌëúÏãú
                                      if (supply >= 1000000000) {
                                        return (supply / 1000000000).toFixed(2) + ' B';
                                      } else if (supply >= 1000000) {
                                        return (supply / 1000000).toFixed(2) + ' M';
                                      } else if (supply >= 1000) {
                                        return (supply / 1000).toFixed(2) + ' K';
                                      } else {
                                        return supply.toLocaleString();
                                      }
                                    }
                                    return '-';
                                  })()}
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}  
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
