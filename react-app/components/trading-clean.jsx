'use client';

import React, { useEffect, useMemo, useRef, useState } from "react";
import { Card, CardContent, CardHeader } from "@/components/ui/card";
import { Search } from "lucide-react";
import axios from "axios";
import TradingChart from "./trading-chart.jsx";
import OrderBook from "./trading-hoga.jsx";
import CoinInfoPanel from "@/components/trading-coininfo";
import { toast } from "sonner";

// ======================= ÏÉÅÏàò =======================
const TRADE_API = "http://localhost:8080/api/trade";

// ======================= Ïú†Ìã∏/ÏïÑÏù¥ÏΩò =======================
function StarIcon({ filled = false, size = 18, className = "" }) {
  const d = "M12 17.27 18.18 21 16.54 13.97 22 9.24 14.81 8.62 12 2 9.19 8.63 2 9.24 7.46 13.97 5.82 21 12 17.27Z";
  return (
    <svg viewBox="0 0 24 24" width={size} height={size} className={className} aria-hidden="true">
      {filled ? (
        <path d={d} fill="currentColor" />
      ) : (
        <path d={d} fill="none" stroke="currentColor" strokeWidth="1.6" />
      )}
    </svg>
  );
}

/* ---------------------- Î©îÏù∏ Îã®Ïùº ÌååÏùº Ïï± ---------------------- */
export default function TradingInterface() {
  // ÏÇ¨Ïö©Ïûê id Ï∂îÏ∂ú
  const [user_id, setUserId] = useState(null);

  // ÌôîÎ©¥ Ï†ÑÌôò ÏÉÅÌÉú (Î™©Î°ù/ÏÉÅÏÑ∏) - Î∞îÎ°ú ÏÉÅÏÑ∏ ÌôîÎ©¥ÏúºÎ°ú ÏãúÏûë
  const [view, setView] = useState("detail");
  
  // ÏãúÏÑ∏/ÏΩîÏù∏Ï†ïÎ≥¥ ÌÉ≠ ÏÉÅÌÉú
  const [detailView, setDetailView] = useState("chart");

  // ÏΩîÏù∏ Î™©Î°ù Í¥ÄÎ†® ÏÉÅÌÉú
  const [coinList, setCoinList] = useState([]);
  const [coinListLoading, setCoinListLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState("");
  const [selectedCoin, setSelectedCoin] = useState("BTC");

  // Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ†® ÏÉÅÌÉú
  const [realTimeData, setRealTimeData] = useState({});
  const [wsConnected, setWsConnected] = useState(false);
  const [wsStats, setWsStats] = useState({
    total_symbols: 0,
    active_subscriptions: 0,
    last_update: null
  });

  // Ìò∏Í∞ÄÏ∞Ω ÏÉÅÌÉú
  const [orderbook, setOrderbook] = useState({ bids: [], asks: [], timestamp: null });

  // Ï£ºÎ¨∏ Í∞ÄÍ≤©/ÏàòÎüâ
  const [orderPrice, setOrderPrice] = useState(0);
  const [orderQty, setOrderQty] = useState(0);
  const [orderType, setOrderType] = useState("ÏãúÏû•Í∞Ä"); // "ÏãúÏû•Í∞Ä" | "ÏßÄÏ†ïÍ∞Ä"
  const [orderPriceInput, setOrderPriceInput] = useState(""); // Î¨∏ÏûêÏó¥(ÏßÄÏ†ïÍ∞Ä ÏûÖÎ†•Ï∞Ω ÌëúÏãúÏö©)

  // Ï£ºÎ¨∏ ÌÉ≠ ÏÉÅÌÉú
  const [orderTab, setOrderTab] = useState("Í±∞Îûò");
  
  // Í±∞Îûò ÏÑúÎ∏åÌÉ≠ ÏÉÅÌÉú
  const [tradeSubTab, setTradeSubTab] = useState("Îß§Ïàò");
  
  // Í±∞ÎûòÎÇ¥Ïó≠ ÏÑúÎ∏åÌÉ≠ ÏÉÅÌÉú
  const [historyTab, setHistoryTab] = useState("Ï≤¥Í≤∞");

  // Ìò∏Í∞ÄÏ∞Ω & Í±∞ÎûòÏ†ïÎ≥¥ ÏïÑÏΩîÎîîÏñ∏ ÏÉÅÌÉú
  const [expandedSections, setExpandedSections] = useState({
    Ìò∏Í∞Ä: false,
    Í±∞ÎûòÏ†ïÎ≥¥: false
  });

  // Ï£ºÎ¨∏Ï∞Ω ÏïÑÏΩîÎîîÏñ∏ ÏÉÅÌÉú
  const [orderPanelExpanded, setOrderPanelExpanded] = useState(false);

  // Ï∞®Ìä∏ ÌÉ≠Ìå¨ ÏïÑÏΩîÎîîÏñ∏ ÏÉÅÌÉú
  const [chartPanelExpanded, setChartPanelExpanded] = useState(false);

  // Ï∞®Ìä∏ & ÏΩîÏù∏Ï†ïÎ≥¥ ÌÉ≠Ìå¨ ÏÉÅÌÉú
  const [chartTab, setChartTab] = useState("Ï∞®Ìä∏");

  // ÏõêÌôî/Î≥¥Ïú†/Í¥ÄÏã¨ ÌÉ≠ ÏÉÅÌÉú
  const [tab, setTab] = useState("won");

  // Í¥ÄÏã¨ ÏΩîÏù∏ ÏÉÅÌÉú
  const [favoriteCoins, setFavoriteCoins] = useState(new Set(["BTC", "ETH"]));

  // ÏΩîÏù∏ id(asset_id) Í∞ÄÏ†∏Ïò§Í∏∞
  const [asset_id, setAsset_id] = useState(null);

  // Responsive height
  const mainPanelRef = useRef(null);
  const [combinedHeight, setCombinedHeight] = useState(600);
    // Ï≤¥Í≤∞/ÎØ∏Ï≤¥Í≤∞ Î¶¨Ïä§Ìä∏ ‚ÄúÎçîÎ≥¥Í∏∞‚ÄùÏö© Í∞úÏàò
const [historyShowCount, setHistoryShowCount] = useState(10);

  // Í¥ÄÏã¨ ÏΩîÏù∏ ÌÜ†Í∏Ä Ìï®Ïàò
  const toggleFavorite = (symbol, e) => {
    e.stopPropagation(); // ÏΩîÏù∏ ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏ Î∞©ÏßÄ
    setFavoriteCoins(prev => {
      const newSet = new Set(prev);
      if (newSet.has(symbol)) {
        newSet.delete(symbol);
      } else {
        newSet.add(symbol);
      }
      return newSet;
    });
  };

  // Ìò∏Í∞ÄÏ∞Ω & Í±∞ÎûòÏ†ïÎ≥¥ ÏïÑÏΩîÎîîÏñ∏ ÌÜ†Í∏Ä Ìï®Ïàò
  const toggleSection = (section) => {
    setExpandedSections(prev => ({
      ...prev,
      [section]: !prev[section]
    }));
  };



  // ======== ÏÇ¨Ïö©Ïûê ID Í∞ÄÏ†∏Ïò§Í∏∞ ========
  useEffect(() => {
    const cached = sessionStorage.getItem("cached_user_id");
    if (cached && user_id == null) setUserId(Number(cached));

    const tokenValue = sessionStorage.getItem("auth_token");
    if (!tokenValue) return;

    let payload = null;
    try {
      payload = JSON.parse(atob(tokenValue.split(".")[1]));
    } catch (_) {
      return;
    }
    const user_mail = payload.email || payload.sub || null;
    if (!user_mail) return;

    let mounted = true;
    const controller = new AbortController();
    const idle = window.requestIdleCallback || ((cb) => setTimeout(cb, 0));

    idle(async () => {
      if (!mounted) return;
      try {
        const res = await fetch(`http://localhost:8080/api/mypage/user-id?email=${encodeURIComponent(user_mail)}`, {
          signal: controller.signal, headers: { Accept: "application/json" }
        });
        if (res.ok) {
          const data = await res.json();
          if (data && data.user_id != null) {
            const idNum = Number(data.user_id);
            setUserId(idNum);
            sessionStorage.setItem("cached_user_id", String(idNum));
          }
        }
      } catch {
        const cached = sessionStorage.getItem("cached_user_id");
        if (cached) setUserId(Number(cached));
      }
    });

    return () => { mounted = false; controller.abort(); };
  }, []);

  // ======================= asset_id Í∞ÄÏ†∏Ïò§Í∏∞ =======================
  async function fetchAssetId(assetSymbol) {
    try {
      const url = `http://localhost:8080/api/Market_assets/asset-id?asset_symbol=${encodeURIComponent(assetSymbol)}`;
      const res = await fetch(url, { headers: { Accept: "application/json" } });
      if (!res.ok) return null;
      const arr = await res.json();
      if (Array.isArray(arr) && arr.length) {
        const n = Number(arr[0]);
        return Number.isFinite(n) ? n : null;
      }
    } catch (err) {
      console.log("API ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïã§Ìå® - asset_id Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®");
      return null;
    }
    return null;
  }

  // ÏÑ†ÌÉù ÏΩîÏù∏ Î∞îÎÄî Îïå asset_id ÏûêÎèô Î°úÎìú
  useEffect(() => {
    let mounted = true;
    (async () => {
      if (!selectedCoin) return;
      const assetSymbol = `${selectedCoin}-KRW`;
      const id = await fetchAssetId(assetSymbol);
      if (mounted) setAsset_id(id);
    })();
    return () => { mounted = false; };
  }, [selectedCoin]);

  // ======================= ÎÜíÏù¥ Í≥ÑÏÇ∞ =======================
  useEffect(() => {
    function updateHeight() {
      if (mainPanelRef.current) setCombinedHeight(mainPanelRef.current.offsetHeight);
    }
    updateHeight();
    window.addEventListener('resize', updateHeight);
    const ro = mainPanelRef.current ? new window.ResizeObserver(updateHeight) : null;
    if (ro && mainPanelRef.current) ro.observe(mainPanelRef.current);
    return () => {
      window.removeEventListener('resize', updateHeight);
      if (ro && mainPanelRef.current) ro.disconnect();
    };
  }, []);

  // ÎπóÏç∏ WebSocket Ïó∞Í≤∞
  useEffect(() => {
    console.log('üöÄ ÎπóÏç∏ Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Ïó∞Í≤∞ ÏãúÏûë...');
    let ws;
    let reconnectTimeout;
    let heartbeatInterval;

    const connectWebSocket = () => {
      const wsUrl = 'ws://localhost:8000/api/realtime';
      console.log(`üîå Ïó∞Í≤∞ ÏãúÎèÑ: ${wsUrl}`);

      try {
        ws = new WebSocket(wsUrl);
        ws.onopen = () => {
          setWsConnected(true);
          console.log('‚úÖ ÎπóÏç∏ Ïã§ÏãúÍ∞Ñ WebSocket Ïó∞Í≤∞ ÏÑ±Í≥µ');
          
          heartbeatInterval = setInterval(() => {
            if (ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ type: 'ping' }));
          }, 30000);
        };
        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            
            if (data.type === 'ticker' && data.content) {
              const c = data.content;
              const content = data.content;
              
              if (content.tickType && content.tickType !== '24H') return;
              const symbol = content.symbol;
              if (!symbol) return;
        
              const closePrice = parseFloat(content.closePrice);
              const chgRate = parseFloat(content.chgRate);
              const value = parseFloat(content.value || 0);
        
              if (isNaN(closePrice) || isNaN(value) || value <= 0) {
                return;
              }
        
              setRealTimeData(prev => {
                const prevPrice = prev[symbol]?.closePrice ?? closePrice;
                return {
                  ...prev,
                  [symbol]: {
                    symbol,
                    closePrice,
                    chgRate,
                    chgAmt: parseFloat(c.chgAmt) || 0,
                    value,
                    // Ï∂îÍ∞Ä Îç∞Ïù¥ÌÑ∞Îì§
                    volume: parseFloat(c.volume) || parseFloat(c.unitsTraded) || 0,
                    highPrice: parseFloat(c.highPrice) || parseFloat(c.high24h) || 0,
                    lowPrice: parseFloat(c.lowPrice) || parseFloat(c.low24h) || 0,
                    timestamp: c.timestamp || Date.now(),
                    priceDirection: closePrice > prevPrice ? 'up' : closePrice < prevPrice ? 'down' : 'same',
                    lastUpdate: Date.now()
                  }
                };
              });
            } else if (data.type === 'orderbook' && data.content) {  // Ïù¥ Î∂ÄÎ∂Ñ Ï∂îÍ∞Ä
              // Ìò∏Í∞Ä Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨
              const { symbol, bids, asks } = data.content;
              if (symbol === selectedCoin + '_KRW') {
                console.log('Orderbook Îç∞Ïù¥ÌÑ∞ ÏàòÏã†:', { symbol, bids, asks });
                setOrderbook({ bids, asks, timestamp: Date.now() });
              }
            }
          } catch {}
        };
        ws.onclose = (event) => {
          setWsConnected(false);
          console.log('‚ùå WebSocket Ïó∞Í≤∞ Ï¢ÖÎ£å:', event.code, event.reason);
          
          if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
          }
          
          reconnectTimeout = setTimeout(() => {
            console.log('üîÑ WebSocket Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ...');
            connectWebSocket();
          }, 3000);
        };
        ws.onerror = () => {
          setWsConnected(false);
          reconnectTimeout = setTimeout(connectWebSocket, 3000);
        };
      } catch {
        setWsConnected(false);
        reconnectTimeout = setTimeout(connectWebSocket, 3000);
      }
    };
    connectWebSocket();
    return () => {
      if (reconnectTimeout) clearTimeout(reconnectTimeout);
      if (heartbeatInterval) clearInterval(heartbeatInterval);
      if (ws && ws.readyState === WebSocket.OPEN) ws.close();
    };
  }, [selectedCoin]);

  // WebSocket ÌÜµÍ≥Ñ Í∞ÄÏ†∏Ïò§Í∏∞
  useEffect(() => {
    const fetchStats = async () => {
      try {
        const response = await fetch('http://localhost:8000/api/websocket/stats');
        if (response.ok) {
          const data = await response.json();
          setWsStats(data.subscription_stats || data || {});
        }
      } catch (error) {
        // Ïò§Î•ò Î°úÍ∑∏ Ï†úÍ±∞
      }
    };
    if (wsConnected) {
      fetchStats();
      const interval = setInterval(fetchStats, 30000);
      return () => clearInterval(interval);
    }
  }, [wsConnected]);

  // ÏΩîÏù∏ Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
  useEffect(() => {
    const fetchCoins = async () => {
      try {
        setCoinListLoading(true);
        console.log(`üîÑ ÏõêÌôî ÎßàÏºì ÏΩîÏù∏ Î™©Î°ù ÏöîÏ≤≠...`);
        const apiUrl = 'http://localhost:8000/api/coins';
        const response = await fetch(apiUrl);
        const data = await response.json();
        
      if (data?.status === 'success' && Array.isArray(data?.data)) {
          console.log(`‚úÖ ÏõêÌôî ÎßàÏºì ${data.data.length}Í∞ú ÏΩîÏù∏ Î°úÎìú ÏÑ±Í≥µ`);
                     const mappedCoins = data.data.map(coin => ({
             symbol: coin.symbol,
             name: coin.korean_name || coin.symbol,
             englishName: coin.english_name || coin.symbol,
          price: Number(coin.current_price) || 0,
          change: Number(coin.change_rate) || 0,
          changeAmount: Number(coin.change_amount) || 0,
          volume: Number(coin.volume) || 0,
          trend: (Number(coin.change_rate) || 0) > 0 ? 'up' : 'down',
             marketWarning: coin.market_warning || 'NONE',
          marketCap: Number(coin.market_cap) || 0,
          marketCapRank: Number(coin.market_cap_rank) || 0,
             // Ï∂îÍ∞Ä Ï†ïÎ≥¥Îì§
          circulatingSupply: Number(coin.circulating_supply) || 0,
          high24h: Number(coin.high_24h) || 0,
          low24h: Number(coin.low_24h) || 0,
          unitsTraded: Number(coin.units_traded) || 0
           }));
          setCoinList(mappedCoins);
      } else {
        // ‚úÖ Ïã§Ìå®/Îπà Î∞∞Ïó¥ÎèÑ Î™ÖÌôïÌûà Ï≤òÎ¶¨
        setCoinList([]);
        }
      } catch (e) {
      console.error('‚ùå ÏõêÌôî ÎßàÏºì Ï°∞Ìöå Ïã§Ìå®:', e);
      setCoinList([]); // ÎÑ§Ìä∏ÏõåÌÅ¨ ÏóêÎü¨ÎèÑ ÎπÑÏö∞Í∏∞
      } finally {
      setCoinListLoading(false); // Î¨¥Ï°∞Í±¥ Î°úÎî© Ï¢ÖÎ£å
      }
    };

    fetchCoins();
  }, []);

  // Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞Î°ú ÏΩîÏù∏ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
  const updatedCoinList = useMemo(() => {
    return coinList.map(coin => {
      const rt = realTimeData[coin.symbol + '_KRW'];
      // Îì±ÎùΩÎ•†/Îì±ÎùΩÍ∏àÏï°ÏùÄ REST(ÎπóÏç∏) Í∞íÎßå ÏÇ¨Ïö©
      let change = coin.change || 0;
      let changeAmount = coin.changeAmount || 0;
      let trend = change > 0 ? 'up' : change < 0 ? 'down' : 'same';
      let price = coin.price || 0;
      if (rt && !Number.isNaN(Number(rt.closePrice))) {
        price = Math.floor(Number(rt.closePrice)) || 0;
      }
      // Í±∞ÎûòÎüâ Îì±ÏùÄ Ïã§ÏãúÍ∞Ñ Î∞òÏòÅ
      const millionValue = rt && Number(rt.value) > 0 ? Math.round(Number(rt.value) / 1_000_000) : 0;
      const formattedVolume = millionValue ? `${millionValue.toLocaleString()} Î∞±Îßå` : '';
      return {
        ...coin,
        price,
        change,
        changeAmount,
        trend,
        volume: formattedVolume || (Number(coin.volume) ? `${Math.round(Number(coin.volume)/1_000_000).toLocaleString()} Î∞±Îßå` : '')
      };
    });
  }, [coinList, realTimeData]);

  // Ï†ïÎ†¨ ÏÉÅÌÉú
  const [sortKey, setSortKey] = useState('volume');
  const [sortOrder, setSortOrder] = useState('desc');

  // Ï†ïÎ†¨ Ìï∏Îì§Îü¨
  const handleSort = (key) => {
    if (sortKey === key) setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');
    else { setSortKey(key); setSortOrder('desc'); }
  };

  // ÌïÑÌÑ∞ÎßÅÎêú ÏΩîÏù∏ Î™©Î°ù
  const filteredCoinList = useMemo(() => {
    let filtered = updatedCoinList;
    if (searchTerm.trim()) {
      const lower = searchTerm.trim().toLowerCase();
      filtered = updatedCoinList.filter(c =>
        (c.name && c.name.toLowerCase().includes(lower)) ||
        (c.symbol && c.symbol.toLowerCase().includes(lower))
      );
    }

    const sorted = [...filtered].sort((a, b) => {
      let aValue = a[sortKey];
      let bValue = b[sortKey];
      
      if (sortKey === 'volume') {
        aValue = typeof aValue === 'string' ? parseFloat(aValue.replace(/[^\d.]/g, '')) : aValue;
        bValue = typeof bValue === 'string' ? parseFloat(bValue.replace(/[^\d.]/g, '')) : bValue;
      }
      
      if (typeof aValue === 'string') aValue = aValue.toLowerCase();
      if (typeof bValue === 'string') bValue = bValue.toLowerCase();
      if (aValue === undefined) return 1;
      if (bValue === undefined) return -1;
      
      if (sortOrder === 'asc') {
        if (aValue < bValue) return -1;
        if (aValue > bValue) return 1;
        return 0;
      } else {
        if (aValue > bValue) return -1;
        if (aValue < bValue) return 1;
        return 0;
      }
      if (typeof av === 'string') av = av.toLowerCase();
      if (typeof bv === 'string') bv = bv.toLowerCase();
      if (av === undefined) return 1;
      if (bv === undefined) return -1;
      if (sortOrder === 'asc') return av < bv ? -1 : av > bv ? 1 : 0;
      return av > bv ? -1 : av < bv ? 1 : 0;
    });
    return sorted;
  }, [searchTerm, updatedCoinList, sortKey, sortOrder]);

  // ÌòÑÏû¨Í∞Ä Í≥ÑÏÇ∞
  const currentPriceKRW = useMemo(() => {
    const rt = realTimeData[selectedCoin + "_KRW"];
    if (rt?.closePrice) return parseFloat(rt.closePrice); // parseInt ‚Üí parseFloatÎ°ú Î≥ÄÍ≤ΩÌïòÏó¨ ÏÜåÏàòÏ†ê Ïú†ÏßÄ
    const fallback = updatedCoinList.find(c => c.symbol === selectedCoin)?.price;
    return typeof fallback === "number" ? fallback : 0;
  }, [selectedCoin, realTimeData, updatedCoinList]);

  // ‚úÖ ÏãúÏû•Í∞ÄÏùº ÎïåÎßå ÌòÑÏû¨Í∞ÄÎ°ú orderPrice ÏûêÎèô ÎèôÍ∏∞Ìôî
  // useEffect(() => {
  //   if (orderType !== "ÏãúÏû•Í∞Ä") return; // ÏßÄÏ†ïÍ∞ÄÎ©¥ Í±¥ÎìúÎ¶¨ÏßÄ ÏïäÏùå
  //   setOrderPrice(currentPriceKRW);
  // }, [orderType, currentPriceKRW, selectedCoin]);


  // ÏãúÏû•Í∞ÄÏùº ÎïåÎßå ÌòÑÏû¨Í∞ÄÎ°ú ÏÑ∏ÌåÖ
useEffect(() => {
  if (orderType !== "ÏãúÏû•Í∞Ä") return;
  setOrderPrice(currentPriceKRW);
  setOrderPriceInput(String(currentPriceKRW ?? "")); // ÏãúÏû•Í∞Ä ÌôîÎ©¥Ïóî Ïì∞Ïù¥ÏßÑ ÏïäÏßÄÎßå ÎèôÍ∏∞ÌôîÎßå
}, [orderType, currentPriceKRW, selectedCoin]);

// ÏßÄÏ†ïÍ∞ÄÎ°ú Ï†ÑÌôòÎê† Îïå Ï¥àÍ∏∞Í∞í(Ìïú Î≤à) ÏÑ∏ÌåÖ: ÎπÑÏñ¥ÏûàÏúºÎ©¥ ÌòÑÏû¨Í∞ÄÎ•º Î≥µÏÇ¨
useEffect(() => {
  if (orderType === "ÏßÄÏ†ïÍ∞Ä") {
    // Ïù¥ÎØ∏ ÏûÖÎ†•Ìïú Í∞íÏù¥ ÏóÜÏùÑ ÎïåÎßå Í∏∞Î≥∏Í∞í Ï±ÑÏõÄ
    if (!orderPrice && !orderPriceInput) {
      const seed = Number.isFinite(currentPriceKRW) ? currentPriceKRW : 0;
      setOrderPrice(seed);
      setOrderPriceInput(seed ? String(seed) : "");
    }
  }
  // eslint-disable-next-line react-hooks/exhaustive-deps
}, [orderType]);

// ÏÑ†ÌÉù ÏΩîÏù∏ Î∞îÎÄî Îïå: ÏãúÏû•Í∞ÄÎ©¥ Îî∞ÎùºÍ∞ÄÍ≥†, ÏßÄÏ†ïÍ∞ÄÎ©¥ Í±¥ÎìúÎ¶¨ÏßÄ ÏïäÏùå
useEffect(() => {
  if (orderType !== "ÏãúÏû•Í∞Ä") return;
  setOrderPrice(currentPriceKRW);
  setOrderPriceInput(String(currentPriceKRW ?? ""));
}, [selectedCoin, currentPriceKRW, orderType]);


  // Ï¥àÍ∏∞/Ï£ºÍ∏∞Ï†Å Ìò∏Í∞Ä Ï°∞Ìöå (WS Ïô∏ Î≥¥Ï°∞)
  useEffect(() => {
    if (!selectedCoin) return;
    const fetchOrderbook = async () => {
      try {
        const res = await fetch(`http://localhost:8000/api/orderbook/${selectedCoin}_KRW`);
        if (res.ok) setOrderbook(await res.json());
      } catch (e) {}
    };
    fetchOrderbook();
    const i = setInterval(fetchOrderbook, 3000);
    return () => clearInterval(i);
  }, [selectedCoin]);

  // ÏΩîÏù∏ ÏÑ†ÌÉù Ïãú
  const handleCoinSelect = async (coin) => {
    setSelectedCoin(coin.symbol);
    setView("detail");
    setDetailView("chart");
  };

  // ======================= Í±∞ÎûòÎÇ¥Ïó≠ =======================
  const [unconcluded_orders, setUnconcluded_orders] = useState([]);
  const [concluded_orders, setConcluded_orders] = useState([]);
  const ORDER_TYPE_TEXT = { 0: "Îß§Ïàò", "0": "Îß§Ïàò", 1: "Îß§ÎèÑ", "1": "Îß§ÎèÑ" };
  const pad2 = (n) => String(n).padStart(2, "0");
  const formatTS = (v) => {
    if (!v) return "-";
    let s = typeof v === "string" ? v.replace(" ", "T").replace(/(\.\d{3})\d+$/, "$1") : v;
    if (typeof s !== "string") {
      const n = Number(s); if (Number.isFinite(n)) s = new Date(n).toISOString();
    }
    const d = new Date(s); if (Number.isNaN(d.getTime())) return "-";
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  };
  const formatQty = (n) => {
    const num = Number(n); if (!Number.isFinite(num)) return String(n ?? "-");
    if (num === 0) return "0";
    if (Math.abs(num) < 1e-8) return num.toExponential(2);
    return num.toFixed(8).replace(/\.?0+$/, "");
  };
  const safePrice = (v) => {
    const n = Number(v); return Number.isFinite(n) ? n.toLocaleString() : String(v ?? "-");
  };
  const normalizeOrder = (row, i) => {
    const tsRaw = row.order_date ?? row.created_at ?? row.timestamp ?? row.ts;
    const typeRaw = row.order_type ?? row.type ?? row.side;
    const amtRaw  = row.amount ?? row.qty ?? row.quantity;
    const priceRaw = row.price;
    return {
      id: row.order_id ?? row.id ?? `${typeRaw ?? "x"}-${i}`,
      ts: formatTS(tsRaw),
      side: ORDER_TYPE_TEXT[typeRaw] ?? (typeof typeRaw === "string" ? typeRaw : "-"),
      qty: formatQty(amtRaw),
      price: safePrice(priceRaw),
    };
  };
  const normalizeOrders = (payload) => {
    const arr = Array.isArray(payload) ? payload : (Array.isArray(payload?.data) ? payload.data : []);
    return arr.map(normalizeOrder);
  };
  const Concluded_orders = async () => {
    if (!user_id || !asset_id) return;
    const { data } = await axios.get(`${TRADE_API}/asset_concluded_orders`, {
      params: { user_id, asset_id }, headers: { Accept: "application/json" },
    });
    setConcluded_orders(normalizeOrders(data));
  };
  const Unconcluded_orders = async () => {
    if (!user_id || !asset_id) return;
    const { data } = await axios.get(`${TRADE_API}/asset_unconcluded_orders`, {
      params: { user_id, asset_id }, headers: { Accept: "application/json" },
    });
    setUnconcluded_orders(normalizeOrders(data));
  };
  useEffect(() => {
    if (orderTab !== "Í±∞ÎûòÎÇ¥Ïó≠") return;
    if (!user_id || !asset_id) return;
    Concluded_orders();
    Unconcluded_orders();
  }, [orderTab, user_id, asset_id]);
  useEffect(() => {
    if (orderTab !== "Í±∞ÎûòÎÇ¥Ïó≠") return;
    if (!user_id || !asset_id) return;
    if (historyTab === "Ï≤¥Í≤∞") Concluded_orders();
    else Unconcluded_orders();
  }, [historyTab]);

  // Ï≤¥Í≤∞/ÎØ∏Ï≤¥Í≤∞ ÌÜ†Í∏ÄÌï† Îïå ‚ÄúÎçîÎ≥¥Í∏∞‚Äù Ïπ¥Ïö¥Ìä∏ Î¶¨ÏÖã
  useEffect(() => {
    setHistoryShowCount(10);
  }, [historyTab]);


  // ======================= Ï£ºÎ¨∏ API ÎûòÌçº & Ìï∏Îì§Îü¨ =======================
  const api = {
    marketBuy: (body) => axios.post(`${TRADE_API}/market_buy`, body),
    marketSell: (body) => axios.post(`${TRADE_API}/market_sell`, body),
    limitBuy:  (body) => axios.post(`${TRADE_API}/limit_buys`,  body),
    limitSell: (body) => axios.post(`${TRADE_API}/limit_sells`, body),
  };

  const buildOrderBody = async () => {
    if (!user_id) { toast.error("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§."); return null; }
    let id = asset_id;
    if (!id && selectedCoin) {
      const assetSymbol = `${selectedCoin}-KRW`;
      id = await fetchAssetId(assetSymbol);
      if (id) setAsset_id(id);
    }
    if (!id) { toast.error("ÏΩîÏù∏ÏùÑ Î®ºÏ†Ä ÏÑ†ÌÉùÌïòÏÑ∏Ïöî."); return null; }
    if (!orderQty || orderQty <= 0) { toast.error("ÏàòÎüâÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî."); return null; }
    if (orderType === "ÏßÄÏ†ïÍ∞Ä" && (!orderPrice || orderPrice <= 0)) {
      toast.error("ÏßÄÏ†ïÍ∞Ä Ï£ºÎ¨∏ÏùÄ Í∞ÄÍ≤©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî."); return null;
    }
    const priceToSend = orderType === "ÏãúÏû•Í∞Ä" ? currentPriceKRW : orderPrice;
    return { user_id, asset_id: id, amount: orderQty, price: priceToSend };
  };

  const handleBuy = async () => {
    const body = await buildOrderBody(); if (!body) return;
    try {
      if (orderType === "ÏãúÏû•Í∞Ä") await api.marketBuy(body);
      else await api.limitBuy(body);
      toast.success(`${selectedCoin} ${orderType} Îß§Ïàò Ï£ºÎ¨∏ ÏôÑÎ£å`);
      setOrderQty(0);
    } catch (err) {
      console.error("Îß§Ïàò Ïã§Ìå®:", err);
      const msg = err.response?.data?.message || err.message || "ÏöîÏ≤≠ Ïã§Ìå®";
      toast.error(`Îß§Ïàò Ï£ºÎ¨∏ Ïã§Ìå®: ${msg}`);
    }
  };

  const handleSell = async () => {
    const body = await buildOrderBody(); if (!body) return;
    try {
      if (orderType === "ÏãúÏû•Í∞Ä") await api.marketSell(body);
      else await api.limitSell(body);
      toast.success(`${selectedCoin} ${orderType} Îß§ÎèÑ Ï£ºÎ¨∏ ÏôÑÎ£å`);
      setOrderQty(0);
    } catch (err) {
      console.error("Îß§ÎèÑ Ïã§Ìå®:", err);
      const msg = err.response?.data?.message || err.message || "ÏöîÏ≤≠ Ïã§Ìå®";
      toast.error(`Îß§ÎèÑ Ï£ºÎ¨∏ Ïã§Ìå®: ${msg}`);
    }
  };

  // ======================= Î†åÎçî =======================
  return (
    <div className="w-full p-0 space-y-4">
      {/* Ïó∞Í≤∞ ÏÉÅÌÉú */}
       <div className="flex items-center justify-between bg-gray-100 dark:bg-gray-800 p-3 rounded-lg mb-4">
        <div className="flex items-center gap-2">
           <span className={`text-sm font-semibold ${wsConnected ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>
            {wsConnected ? 'üü¢ Í±∞ÎûòÏÜå Ïã§ÏãúÍ∞Ñ Ïó∞Í≤∞Îê®' : 'üî¥ Ïó∞Í≤∞ ÎÅäÏñ¥Ïßê'}
          </span>
           <span className="text-sm text-gray-500 dark:text-gray-400">
             Ïã§ÏãúÍ∞Ñ: {Object.keys(realTimeData).length}Í∞ú | Ï¥ù ÏΩîÏù∏: {coinList.length}Í∞ú
          </span>
        </div>
         <div className="text-sm text-gray-500 dark:text-gray-400">ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏: {new Date().toLocaleTimeString()}</div>
      </div>

      {/* ÏÉÅÏÑ∏ ÌôîÎ©¥ */}
      <div className="w-full">
        <div className="flex items-center justify-between mb-4">
          <div className="w-2/5 flex justify-center">
            <div className="text-4xl font-bold"><span>Ï¢ÖÎ™©(ÏÉÅÌíà)</span></div>
          </div>
        </div>

        <div className="flex flex-row min-h-0" style={{ height: combinedHeight }}>
          {/* Ï¢å: ÏΩîÏù∏Î™©Î°ù */}
          <div className="flex flex-col w-2/5 min-h-0" style={{ height: 600 }}>
            <Card className="flex flex-col border-0" style={{ height: 1200 }}>
              <CardHeader className="pb-2">
                <div className="flex items-center gap-2.5 mb-2">
                   <Search className="h-4 w-4 text-muted-foreground dark:text-gray-400" />
                  <input
                    placeholder="ÏΩîÏù∏Î™Ö/Ïã¨Î≥ºÍ≤ÄÏÉâ"
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                     className="h-10 flex-1 border border-gray-300 dark:border-gray-600 rounded px-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400"
                    autoComplete="off"
                  />
                </div>
{/* Ïû†Íπê Ï£ºÏÑù */}
                {/* <div className="flex bg-gray-100 rounded-lg p-1 w-full mb-4 shadow-sm">
                  {[
                    { key: "won", label: "ÏõêÌôî" },
                    { key: "hold", label: "Î≥¥Ïú†" },
                    { key: "star", label: "Í¥ÄÏã¨" },
                  ].map((t, i) => (
                    <button
                      key={t.key}
                      onClick={() => setTab(t.key)}
                      className={`flex-1 py-2 px-3 text-center text-sm font-medium transition-all duration-200 rounded-md flex flex-col justify-end
                        ${t.key === tab ? "bg-white text-gray-800 shadow-sm font-semibold" : "text-gray-500 hover:text-gray-700"}
                        ${i === 0 ? "rounded-l-md" : ""} ${i === 2 ? "rounded-r-md" : ""}`}
                      style={{ minWidth: 0 }}
                    >
                      {t.label}
                    </button>
                  ))}
                </div> */}
              </CardHeader>

              <CardContent className="p-0 flex-1 flex flex-col min-h-0" style={{ height: 600 }}>
                                 <div className="grid grid-cols-[auto_1fr_1fr_1fr_1fr] gap-6 px-2 py-2 text-sm font-bold text-muted-foreground dark:text-gray-400 border-b border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 sticky top-0 z-10"
                  style={{ height: '40px', minHeight: '40px', maxHeight: '40px', flexShrink: 0, overflow: 'hidden' }}>
                  <div className="text-center gap-3" />
                   <div className="flex items-center cursor-pointer text-left" onClick={() => handleSort('name')}>ÌïúÍ∏ÄÎ™Ö{sortKey === 'name' ? (<span className="text-[10px] text-blue-600 dark:text-blue-400">{sortOrder === 'asc' ? '‚ñ≤' : '‚ñº'}</span>) : (<span className="text-[10px] text-gray-300 dark:text-gray-500">‚ñ≥‚ñΩ</span>)}</div>
                   <div className="text-right flex items-center gap-1 cursor-pointer" onClick={() => handleSort('price')}>ÌòÑÏû¨Í∞Ä{sortKey === 'price' ? (<span className="text-[10px] text-blue-600 dark:text-blue-400">{sortOrder === 'asc' ? '‚ñ≤' : '‚ñº'}</span>) : (<span className="text-[10px] text-gray-300 dark:text-gray-500">‚ñ≥‚ñΩ</span>)}</div>
                   <div className="text-right flex items-center gap-1 cursor-pointer" onClick={() => handleSort('change')}>Ï†ÑÏùºÎåÄÎπÑ{sortKey === 'change' ? (<span className="text-[10px] text-blue-600 dark:text-blue-400">{sortOrder === 'asc' ? '‚ñ≤' : '‚ñº'}</span>) : (<span className="text-[10px] text-gray-300 dark:text-gray-500">‚ñ≥‚ñΩ</span>)}</div>
                   <div className="text-right flex items-center gap-1 cursor-pointer" onClick={() => handleSort('volume')}>Í±∞ÎûòÎåÄÍ∏à{sortKey === 'volume' ? (<span className="text-[10px] text-blue-600 dark:text-blue-400">{sortOrder === 'asc' ? '‚ñ≤' : '‚ñº'}</span>) : (<span className="text-[10px] text-gray-300 dark:text-gray-500">‚ñ≥‚ñΩ</span>)}</div>
                </div>

                <div className="overflow-y-auto flex-1 min-h-0" style={{ height: combinedHeight, flexShrink: 0 }}>
                  {coinListLoading ? (
                    <div className="p-4 text-center text-gray-500">Î°úÎî© Ï§ë...</div>
                  ) : filteredCoinList.length === 0 ? (
                    <div className="p-4 text-center text-gray-500">ÏΩîÏù∏ Î™©Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</div>
                  ) : (
                    filteredCoinList.map((coin) => (
                      <div
                        key={coin.symbol}
                        onClick={() => handleCoinSelect(coin)}
                        className={`grid grid-cols-[auto_1fr_1fr_1fr_1fr] gap-3 p-1 text-sm cursor-pointer border-b items-center
                          ${selectedCoin === coin.symbol ? 'bg-blue-50 border-blue-200' : ''}`}
                        style={{ height: '48px', minHeight: '48px', maxHeight: '48px', flexShrink: 0, overflow: 'hidden' }}
                      >
                        <div className="flex justify-center items-center" style={{ height: '100%', flexShrink: 0, overflow: 'hidden' }}>
                          <button onClick={(e) => toggleFavorite(coin.symbol, e)} className="p-1 hover:bg-gray-100 rounded transition-colors">
                            <StarIcon filled={favoriteCoins.has(coin.symbol)} size={18} className={favoriteCoins.has(coin.symbol) ? "text-yellow-500" : "text-gray-400"} />
                          </button>
                        </div>

                        <div className="flex items-center gap-1 text-left" style={{ height: '100%', flexShrink: 0, overflow: 'hidden' }}>
                          <div className="flex flex-col justify-center" style={{ width: '100%' }}>
                            <div className={`font-semibold text-sm ${selectedCoin === coin.symbol ? 'text-black dark:text-black' : ''}`} style={{ lineHeight: '1.2', verticalAlign: 'baseline' }}>
                              {coin.name}
                              {realTimeData[coin.symbol + '_KRW'] && (<span className="ml-1 text-green-500 text-[8px]" style={{ lineHeight: '1', verticalAlign: 'baseline' }}>‚óè</span>)}
                            </div>
                            <div className="text-muted-foreground text-sm" style={{ lineHeight: '1.2', verticalAlign: 'baseline' }}>{coin.symbol}/KRW</div>
                          </div>
                        </div>

                        <div className={`text-right font-mono font-semibold text-lg flex items-center justify-end ${selectedCoin === coin.symbol ? 'text-black dark:text-black' : ''}`}
                          style={{ height: '100%', flexShrink: 0, overflow: 'hidden' }}>
                          <span style={{ lineHeight: '1', verticalAlign: 'baseline' }}>
                            {(() => {
                              const r = realTimeData[coin.symbol + '_KRW']?.closePrice;
                              let price = typeof r !== 'undefined' ? Number(r) : coin.price;
                              if (!Number.isFinite(price)) price = 0;
                              if (price < 10) return price.toLocaleString(undefined, { minimumFractionDigits: 4, maximumFractionDigits: 8 });
                              if (price < 100) return price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                              return Math.floor(price).toLocaleString();
                            })()}
                          </span>
                        </div>

                        <div className={`text-right font-semibold flex flex-col justify-center ${coin.trend === 'up' ? 'text-red-600' : 'text-blue-600'}`}
                          style={{ height: '100%', flexShrink: 0, overflow: 'hidden' }}>
                          {/* Ï†ÑÏùºÎåÄÎπÑ(%) */}
                          <div style={{ lineHeight: '1.2', verticalAlign: 'baseline' }}>
                            {coin.change > 0 ? '+' : coin.change < 0 ? '' : ''}
                            {typeof coin.change === 'number' ? coin.change.toFixed(2) : '0.00'}%
                          </div>
                          {/* Ï†ÑÏùºÎåÄÎπÑ(Í∏àÏï°) */}
                          <div className="text-sm" style={{ lineHeight: '1.2', verticalAlign: 'baseline' }}>
                            {coin.changeAmount > 0 ? '+' : coin.changeAmount < 0 ? '' : ''}
                            {typeof coin.changeAmount === 'number' ? Math.abs(coin.changeAmount).toLocaleString() : '0'}
                          </div>
                        </div>

                        <div className={`text-right text-sm flex items-center justify-end ${selectedCoin === coin.symbol ? 'text-black dark:text-black' : ''}`}
                          style={{ height: '100%', flexShrink: 0, overflow: 'hidden' }}>
                          <span style={{ lineHeight: '1', verticalAlign: 'baseline' }}>{coin.volume !== '' ? coin.volume : '-'}</span>
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </CardContent>
            </Card>
          </div>

          {/* Ïö∞: Ï∞®Ìä∏/Ï£ºÎ¨∏ */}
          <div className="flex flex-col min-h-0 gap-4 h-full w-3/5" ref={mainPanelRef}>
            {/* Ï∞®Ìä∏/ÏΩîÏù∏Ï†ïÎ≥¥ ÌÉ≠ */}
            <div className="w-full" style={{ height: chartPanelExpanded ? combinedHeight : '120px' }}>
               <div className={`flex justify-left border-b border-gray-200 dark:border-gray-700 ${chartPanelExpanded ? 'mb-4' : 'mb-1'}`}>
                <button
                   className={`w-32 px-6 py-3 text-xl font-semibold text-center border-2 border-gray-300 dark:border-gray-600 rounded-t-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors ${
                     chartPanelExpanded && chartTab === "Ï∞®Ìä∏" ? 'text-blue-600 dark:text-blue-400 border-blue-500 dark:border-blue-400 bg-blue-100 dark:bg-blue-900' : 'text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800'
                  }`}
                  onClick={() => {
                    if (chartPanelExpanded && chartTab === "Ï∞®Ìä∏") setChartPanelExpanded(false);
                    else { setChartPanelExpanded(true); setChartTab("Ï∞®Ìä∏"); }
                  }}
                >Ï∞®Ìä∏</button>

                <button
                   className={`w-30 px-6 py-3 text-xl font-semibold text-center border-2 border-gray-300 dark:border-gray-600 rounded-t-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors border-l-0 rounded-l-none ${
                     chartPanelExpanded && chartTab === "ÏΩîÏù∏Ï†ïÎ≥¥" ? 'text-blue-600 dark:text-blue-400 border-blue-500 dark:border-blue-400 bg-blue-100 dark:bg-blue-900' : 'text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800'
                  }`}
                  onClick={() => {
                    if (chartPanelExpanded && chartTab === "ÏΩîÏù∏Ï†ïÎ≥¥") setChartPanelExpanded(false);
                    else { setChartPanelExpanded(true); setChartTab("ÏΩîÏù∏Ï†ïÎ≥¥"); }
                  }}
                >ÏΩîÏù∏Ï†ïÎ≥¥</button>
              </div>

              {chartPanelExpanded && chartTab === "Ï∞®Ìä∏" && (
                 <div className="p-2" style={{ height: '700px' }}>
                   <div className="bg-white dark:bg-gray-800 rounded h-full">
                    <TradingChart
                      symbol={`${selectedCoin}/KRW`}
                      koreanName={selectedCoin === "BTC" ? "ÎπÑÌä∏ÏΩîÏù∏" : selectedCoin}
                      height={650}
                      theme="light"
                       currentPrice={realTimeData[selectedCoin + '_KRW']?.closePrice || 0}
                      initialTimeframe="1h"
                      onPriceUpdate={(price) => {
                        if (price > 0) {
                          setRealTimeData(prev => ({
                            ...prev,
                            [selectedCoin]: { ...prev[selectedCoin], close_price: price }
                          }));
                        }
                      }}
                    />
                  </div>
                </div>
              )}

              {chartPanelExpanded && chartTab === "ÏΩîÏù∏Ï†ïÎ≥¥" && (
                 <div className="p-4 bg-white dark:bg-gray-800 rounded" style={{ height: '800px', overflowY: 'auto' }}>
                  <CoinInfoPanel
                    coin={coinList.find(c => c.symbol === selectedCoin) || coinList[0]}
                    realTimeData={realTimeData[selectedCoin + '_KRW']}
                    marketCap={coinList.find(c => c.symbol === selectedCoin)?.marketCap || 0}
                  />
                </div>
              )}

              {/* ÌïòÎã®: Ï£ºÎ¨∏/Ìò∏Í∞Ä/Ï†ïÎ≥¥ */}
              {detailView === "chart" && (
                <div className="w-full flex flex-row" style={{ 
                  height: chartPanelExpanded ? 'auto' : '800px', 
                  minHeight: chartPanelExpanded ? '600px' : '800px',
                  marginTop: chartPanelExpanded ? '20px' : '20px' 
                }}>
                  {/* Ï£ºÎ¨∏ ÏòÅÏó≠ */}
                  <div className="flex-1 w-2/3 flex flex-col bg-white dark:bg-gray-800 px-6 overflow-auto"
                    style={{ 
                      minHeight: '600px', 
                      paddingTop: '20px', 
                      paddingBottom: '20px' 
                    }}>
                    {/* Î©îÏù∏ ÌÉ≠ */}
                    <div className="flex justify-center border-b border-gray-200 dark:border-gray-700 mb-4">
                      <button
                        className={`w-full px-6 py-3 text-3xl font-semibold text-center border-2 border-gray-300 dark:border-gray-600 rounded-t-lg transition-colors ${
                          orderPanelExpanded ? 'text-blue-600 dark:text-blue-400 border-blue-500 dark:border-blue-400 bg-blue-50 dark:bg-blue-900' : 'text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700'
                        }`}
                        onClick={() => setOrderPanelExpanded(!orderPanelExpanded)}
                      >Í±∞Îûò</button>
                    </div>

                    {orderPanelExpanded && (
                      <div className="w-4/5 mx-auto">
                        {/* Í±∞Îûò ÏÑúÎ∏åÌÉ≠ */}
                        {orderTab === "Í±∞Îûò" && (
                          <div className="flex border-b border-gray-200 mb-4">
                            {["Îß§Ïàò", "Îß§ÎèÑ", "Í±∞ÎûòÎÇ¥Ïó≠"].map((t) => {
                              let activeClass = "";
                              if (tradeSubTab === t) {
                                if (t === "Îß§Ïàò") activeClass = "border-b-2 border-red-500 text-red-600 font-semibold";
                                else if (t === "Îß§ÎèÑ") activeClass = "border-b-2 border-blue-500 text-blue-600 font-semibold";
                                else if (t === "Í±∞ÎûòÎÇ¥Ïó≠") activeClass = "border-b-2 border-black text-black font-semibold";
                              } else activeClass = "text-gray-500";
                              return (
                                // <button key={t} className={`flex-1 py-2 text-lg ${activeClass}`} onClick={() => setTradeSubTab(t)}>
                                //   {t}
                                // </button>
                                <button
                                  key={t}
                                  className={`flex-1 py-2 text-lg ${activeClass}`}
                                  onClick={() => {
                                    setTradeSubTab(t);
                                    if (t === "Í±∞ÎûòÎÇ¥Ïó≠" && user_id && asset_id) {
                                      if (historyTab === "Ï≤¥Í≤∞") Concluded_orders();
                                      else Unconcluded_orders();
                                    }
                                  }}
                                >
                                  {t}
                                </button>

                              );
                            })}
                          </div>
                        )}

                        {/* Îß§Ïàò/Îß§ÎèÑ */}
                        {orderTab === "Í±∞Îûò" && (tradeSubTab === "Îß§Ïàò" || tradeSubTab === "Îß§ÎèÑ") ? (
                          <>
                            {/* Ï£ºÎ¨∏Ïú†Ìòï */}
                            <div className="flex items-center gap-4 mb-6">
                              <span className="text-md font-semibold text-gray-900 dark:text-gray-100">Ï£ºÎ¨∏Ïú†Ìòï</span>

                              <label className="flex items-center gap-1 text-md font-semibold text-blue-600 dark:text-blue-400">
                                <input
                                  type="radio"
                                  name="orderType"
                                  value="ÏßÄÏ†ïÍ∞Ä"
                                  checked={orderType === "ÏßÄÏ†ïÍ∞Ä"}
                                  onChange={() => setOrderType("ÏßÄÏ†ïÍ∞Ä")}
                                  className="accent-blue-500"
                                /> ÏßÄÏ†ïÍ∞Ä
                              </label>

                              <label className="flex items-center gap-1 text-md text-gray-600 dark:text-gray-400">
                                <input
                                  type="radio"
                                  name="orderType"
                                  value="ÏãúÏû•Í∞Ä"
                                  checked={orderType === "ÏãúÏû•Í∞Ä"}
                                  onChange={() => setOrderType("ÏãúÏû•Í∞Ä")}
                                  className="accent-blue-500"
                                /> ÏãúÏû•Í∞Ä
                              </label>
                            </div>

                            {/* Í∞ÄÍ≤© */}
                            <div className="flex items-center justify-between mb-1">
                              <span className="text-md font-semibold text-gray-900 dark:text-gray-100">
                                {tradeSubTab === "Îß§Ïàò" ? "Îß§ÏàòÍ∞ÄÍ≤© (KRW)" : "Îß§ÎèÑÍ∞ÄÍ≤© (KRW)"}
                              </span>
                              <div className="text-sm text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">
                                ÌòÑÏû¨Í∞Ä {(() => {
                                  const r = realTimeData[selectedCoin + '_KRW']?.closePrice;
                                  let price = typeof r !== 'undefined' ? Number(r) : currentPriceKRW;
                                  if (!Number.isFinite(price)) price = 0;
                                  if (price < 10) return price.toLocaleString(undefined, { minimumFractionDigits: 4, maximumFractionDigits: 8 });
                                  if (price < 100) return price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                                  return Math.floor(price).toLocaleString();
                                })()} KRW
                              </div>
                            </div>
                            <input
  type="text"
  inputMode="decimal"
  pattern="[0-9]*[.]?[0-9]*"
  value={
    orderType === "ÏãúÏû•Í∞Ä"
      // ÏãúÏû•Í∞Ä: ÌôîÎ©¥Ïóê Î≥¥Í∏∞ Ï¢ãÍ≤åÎßå ÌëúÏãú(ÏûÖÎ†• Î∂àÍ∞Ä)
      ? (() => {
          const n = Number(orderPrice);
          if (!Number.isFinite(n)) return "0";
          if (n < 10) return n.toLocaleString(undefined, { minimumFractionDigits: 4, maximumFractionDigits: 8 });
          if (n < 100) return n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
          return Math.floor(n).toLocaleString();
        })()
      // ÏßÄÏ†ïÍ∞Ä: ÏÇ¨Ïö©ÏûêÍ∞Ä ÌÉÄÏù¥ÌïëÌïú ÏõêÎ¨∏ Í∑∏ÎåÄÎ°ú(Ìè¨Îß∑ Í∏àÏßÄ!)
      : orderPriceInput
  }
  onChange={(e) => {
    if (orderType !== "ÏßÄÏ†ïÍ∞Ä") return; // ÏãúÏû•Í∞ÄÎäî ÏûÖÎ†• ÎßâÏùå
    const raw = e.target.value;
    // Ïà´Ïûê/Ï†êÎßå ÌóàÏö©
    if (!/^[0-9]*\.?[0-9]*$/.test(raw)) return;

    setOrderPriceInput(raw);

    // Í≥µÎ∞± ÎòêÎäî Ï†êÎßå ÏûàÎäî Í≤ΩÏö∞Îäî Ïà´Ïûê ÏÑ∏ÌåÖ Î≥¥Î•ò
    if (raw === "" || raw === ".") {
      setOrderPrice(0);
      return;
    }
    const n = Number(raw);
    setOrderPrice(Number.isFinite(n) ? n : 0);
  }}
  disabled={orderType === "ÏãúÏû•Í∞Ä"}
  className="w-full border border-gray-300 dark:border-gray-600 rounded h-16 px-2 mb-6 text-3xl font-semibold disabled:bg-gray-100 dark:disabled:bg-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
  placeholder={orderType === "ÏßÄÏ†ïÍ∞Ä" ? "ÏßÄÏ†ïÍ∞ÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" : "ÏãúÏû•Í∞Ä(ÏûêÎèô)"}
/>


                            {/* ÏàòÎüâ */}
                            <div className="mb-6">
                              <div className="text-md font-semibold mb-1 text-gray-900 dark:text-gray-100">Ï£ºÎ¨∏ÏàòÎüâ</div>
                              <input
                                type="text"
                                value={orderQty}
                                onChange={(e) => setOrderQty(Number(e.target.value) || 0)}
                                className="w-full border border-gray-300 dark:border-gray-600 rounded h-16 px-2 mb-2 text-3xl font-semibold bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
                                placeholder="0"
                              />
                              <div className="flex gap-2">
                                <button className="flex-1 border border-gray-300 dark:border-gray-600 rounded py-1 text-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600" onClick={() => setOrderQty(prev => Number((prev + 0.1).toFixed(8)))}>+0.1</button>
                                <button className="flex-1 border border-gray-300 dark:border-gray-600 rounded py-1 text-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600" onClick={() => setOrderQty(prev => Number((prev + 0.25).toFixed(8)))}>+0.25</button>
                                <button className="flex-1 border border-gray-300 dark:border-gray-600 rounded py-1 text-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600" onClick={() => setOrderQty(prev => Number((prev + 0.5).toFixed(8)))}>+0.5</button>
                                <button className="flex-1 border border-gray-300 dark:border-gray-600 rounded py-1 text-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600" onClick={() => setOrderQty(0)}>Ï¥àÍ∏∞Ìôî</button>
                              </div>
                            </div>

                            {/* Ï¥ùÏï° */}
                            <div className="mb-6">
                              <div className="text-md font-semibold mb-1 text-gray-900 dark:text-gray-100">Ï£ºÎ¨∏Ï¥ùÏï° (KRW)</div>
                              <input
                                type="text"
                                readOnly
                                value={(() => {
                                  const priceForTotal = (orderType === "ÏãúÏû•Í∞Ä" ? currentPriceKRW : orderPrice) || 0;
                                  const totalAmount = priceForTotal * (orderQty || 0);
                                  if (!Number.isFinite(totalAmount)) return "0";
                                  if (totalAmount < 10) return totalAmount.toLocaleString(undefined, { minimumFractionDigits: 4, maximumFractionDigits: 8 });
                                  if (totalAmount < 100) return totalAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                                  return totalAmount.toLocaleString();
                                })()}
                                className="w-full border border-gray-300 dark:border-gray-600 rounded h-16 px-2 bg-gray-50 dark:bg-gray-700 text-3xl font-semibold text-gray-900 dark:text-gray-100"
                                placeholder="0"
                              />
                            </div>

                            {/* Ï£ºÎ¨∏ Î≤ÑÌäº */}
                            {tradeSubTab === "Îß§Ïàò" && (
                              <button
                                className="w-full h-20 rounded-md bg-red-600 text-white text-2xl font-semibold hover:opacity-90"
                                type="button"
                                onClick={handleBuy}
                              >Îß§Ïàò</button>
                            )}
                            {tradeSubTab === "Îß§ÎèÑ" && (
                              <button
                                className="w-full h-20 rounded-md bg-blue-600 text-white text-2xl font-semibold hover:opacity-90"
                                type="button"
                                onClick={handleSell}
                              >Îß§ÎèÑ</button>
                            )}
                          </>
                        ) : null}

                        {/* Í±∞ÎûòÎÇ¥Ïó≠ ÌÉ≠ */}
                        {orderTab === "Í±∞Îûò" && tradeSubTab === "Í±∞ÎûòÎÇ¥Ïó≠" && (
  <div className="text-md">
    {/* ÏÉÅÎã® ÌÜ†Í∏Ä + ÏÉàÎ°úÍ≥†Ïπ® */}
    <div className="flex justify-between items-center mb-3">
      <div className="flex gap-2">
        <button
          type="button"
          className={`px-3 py-1 rounded-md border text-md ${
            historyTab === "ÎØ∏Ï≤¥Í≤∞"
              ? "bg-blue-50 dark:bg-blue-900 text-blue-600 dark:text-blue-400 border-blue-200 dark:border-blue-700"
              : "text-gray-600 dark:text-gray-400 border-gray-200 dark:border-gray-600"
          }`}
          onClick={() => setHistoryTab("ÎØ∏Ï≤¥Í≤∞")}
        >
          ÎØ∏Ï≤¥Í≤∞
        </button>
        <button
          type="button"
          className={`px-3 py-1 rounded-md border text-md ${
            historyTab === "Ï≤¥Í≤∞"
              ? "bg-blue-50 dark:bg-blue-900 text-blue-600 dark:text-blue-400 border-blue-200 dark:border-blue-700"
              : "text-gray-600 dark:text-gray-400 border-gray-200 dark:border-gray-600"
          }`}
          onClick={() => setHistoryTab("Ï≤¥Í≤∞")}
        >
          Ï≤¥Í≤∞
        </button>
      </div>

      <div className="flex gap-2">
        <button
          type="button"
          className="px-3 py-1 rounded-md border text-md bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 border-gray-200 dark:border-gray-600"
          onClick={() => {
            if (historyTab === "Ï≤¥Í≤∞") Concluded_orders();
            else Unconcluded_orders();
          }}
        >
          ÏÉàÎ°úÍ≥†Ïπ®
        </button>

      </div>
    </div>

    {/* Î¶¨Ïä§Ìä∏ Î≥∏Î¨∏ */}
    {(() => {
      // Î∞±ÏóêÏÑú Î∞õÏùÄ ÏõêÎ≥∏ Î∞∞Ïó¥ ÏÑ†ÌÉù
      const src = historyTab === "Ï≤¥Í≤∞" ? concluded_orders : unconcluded_orders;
      const items = Array.isArray(src) ? src : [];

      if (items.length === 0) {
        return (
          <div className="border border-gray-200 dark:border-gray-600 rounded p-4 text-center text-gray-400 dark:text-gray-500 bg-white dark:bg-gray-800">
            {historyTab} ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.
          </div>
        );
      }

      // ÌôîÎ©¥Ïóê Î≥¥Ïùº Í∞úÏàò
      const visible = items.slice(0, historyShowCount);

      return (
        <div className="border border-gray-200 dark:border-gray-600 rounded overflow-hidden bg-white dark:bg-gray-800">
          {/* Ìó§Îçî */}
          <div className="grid grid-cols-[1.1fr_0.6fr_0.6fr_0.8fr] px-3 py-2 text-sm font-semibold bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600 text-gray-900 dark:text-gray-100">
            <div className="text-left">Ï≤¥Í≤∞ÏãúÍ∞Ñ</div>
            <div className="text-center">Íµ¨Î∂Ñ</div>
            <div className="text-right">ÏàòÎüâ</div>
            <div className="text-right">Í∞ÄÍ≤©(KRW)</div>
          </div>

          {/* Î°úÏö∞ */}
          <div className="max-h-[420px] overflow-y-auto">
            {visible.map((r, idx) => (
              <div
                key={r.id ?? idx}
                className="grid grid-cols-[1.1fr_0.6fr_0.6fr_0.8fr] px-3 py-2 text-sm border-b border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-900 dark:text-gray-100"
              >
                <div className="text-left">{r.ts ?? "-"}</div>
                <div
                  className={`text-center font-semibold ${
                    (r.side === "Îß§Ïàò" || r.side === 0 || r.side === "0")
                      ? "text-red-600 dark:text-red-400"
                      : "text-blue-600 dark:text-blue-400"
                  }`}
                >
                  {r.side ?? "-"}
                </div>
                <div className="text-right">{r.qty ?? "-"}</div>
                <div className="text-right">{r.price ?? "-"}</div>
              </div>
            ))}
          </div>

          {/* ÎçîÎ≥¥Í∏∞ */}
          {items.length > historyShowCount && (
            <div className="p-2 bg-white dark:bg-gray-800 flex justify-center">
              <button
                className="px-3 py-1 text-sm border border-gray-200 dark:border-gray-600 rounded hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700"
                onClick={() => setHistoryShowCount((n) => n + 10)}
              >
                ÎçîÎ≥¥Í∏∞ (+10)
              </button>
            </div>
          )}
        </div>
      );
    })()}
  </div>
)}

                      </div>
                    )}
                  </div>

                  {/* Ìò∏Í∞Ä/Ï†ïÎ≥¥ */}
                  <div className="w-1/3 flex flex-col bg-white dark:bg-gray-800 pt-7">
                    {/* Ìò∏Í∞Ä */}
                    <div className="border-b border-gray-200 dark:border-gray-700">
                      <button
                        className={`w-full px-6 py-3 text-3xl font-semibold text-center border-2 border-gray-300 dark:border-gray-600 rounded-t-lg bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors ${
                          expandedSections.Ìò∏Í∞Ä ? 'text-blue-600 dark:text-blue-400 border-blue-500 dark:border-blue-400 bg-blue-50 dark:bg-blue-900' : 'text-gray-500 dark:text-gray-400'
                        }`}
                        onClick={() => toggleSection("Ìò∏Í∞Ä")}
                      >Ìò∏Í∞Ä</button>

                      {expandedSections.Ìò∏Í∞Ä && (
                        <div className="p-4 border-t border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700">
                          <OrderBook
                            selectedCoin={selectedCoin}
                            realTimeData={realTimeData[selectedCoin + '_KRW']}
                            orderbook={orderbook}
                            currentPriceKRW={currentPriceKRW}
                            onPriceSelect={(price) => {
                              // Ìò∏Í∞Ä ÌÅ¥Î¶≠ Ïãú: ÏßÄÏ†ïÍ∞ÄÎ©¥ ÏûÖÎ†•Í∞íÏúºÎ°ú ÏÑ∏ÌåÖ, ÏãúÏû•Í∞ÄÎ©¥ Î¨¥Ïãú
                              if (orderType === "ÏßÄÏ†ïÍ∞Ä") {
                                setOrderPrice(price);
                                setOrderPriceInput(String(price));
                              }
                              if (orderType === "ÏßÄÏ†ïÍ∞Ä") {
                                // JavaScript Î∂ÄÎèôÏÜåÏàòÏ†ê Ïò§Î•ò Î∞©ÏßÄ: Ï†ïÌôïÌïú ÏÜåÏàòÏ†ê ÏûêÎ¶øÏàò Ïú†ÏßÄ
                                const exactPrice = parseFloat(price);
                                setOrderPrice(exactPrice);
                                
                                // Í∞ÄÍ≤©ÎåÄÎ≥Ñ Ï†ïÌôïÌïú ÏÜåÏàòÏ†ê ÏûêÎ¶øÏàòÎ°ú ÌëúÏãú
                                let formattedPrice;
                                if (exactPrice < 1) {
                                  formattedPrice = exactPrice.toFixed(4); // 0.1234
                                } else if (exactPrice < 10) {
                                  formattedPrice = exactPrice.toFixed(4); // 1.5678
                                } else if (exactPrice < 100) {
                                  formattedPrice = exactPrice.toFixed(2); // 41.79
                                } else if (exactPrice < 1000) {
                                  formattedPrice = exactPrice.toFixed(2); // 123.45
                                } else if (exactPrice < 10000) {
                                  formattedPrice = exactPrice.toFixed(2); // 1234.56
                                } else {
                                  formattedPrice = exactPrice.toFixed(2); // 12345.67
                                }
                                
                                setOrderPriceInput(formattedPrice);
                              }
                            }}
                          />
                        </div>
                      )}
                    </div>

                    {/* Í±∞ÎûòÏ†ïÎ≥¥ */}
                    <div className="border-b border-gray-200 dark:border-gray-700">
                      <button
                        className={`w-full px-6 py-3 text-3xl font-semibold text-center border-2 border-gray-300 dark:border-gray-600 rounded-t-lg bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors ${
                          expandedSections.Í±∞ÎûòÏ†ïÎ≥¥ ? 'text-blue-600 dark:text-blue-400 border-blue-500 dark:border-blue-400 bg-blue-50 dark:bg-blue-900' : 'text-gray-500 dark:text-gray-400'
                        }`}
                        onClick={() => toggleSection("Í±∞ÎûòÏ†ïÎ≥¥")}
                      >Í±∞ÎûòÏ†ïÎ≥¥</button>

                      {expandedSections.Í±∞ÎûòÏ†ïÎ≥¥ && (
                        <div className="p-4 border-t border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700">
                          <div className="space-y-3 text-sm text-gray-700 dark:text-gray-300">
                            {/* Í±∞ÎûòÎüâ */}
                            <div className="flex justify-between">
                              <div className="flex items-center space-x-2">
                                <span className="font-semibold text-gray-900 dark:text-gray-100">Í±∞ÎûòÎüâ</span>
                                <span className="text-xs text-gray-400 dark:text-gray-500">(ÏµúÍ∑º24ÏãúÍ∞Ñ)</span>
                              </div>
                              <span className="font-mono text-gray-900 dark:text-gray-100">
                                {(() => {
                                  // realTimeDataÏóêÏÑú Î®ºÏ†Ä ÌôïÏù∏, ÏóÜÏúºÎ©¥ coinListÏóêÏÑú
                                  const rt = realTimeData[selectedCoin + '_KRW'];
                                  const coin = coinList.find(c => c.symbol === selectedCoin);
                                  
                                  if (rt?.volume && rt.volume > 0) {
                                    const vol = parseFloat(rt.volume);
                                    if (vol >= 1000000) return (vol / 1000000).toFixed(2) + 'M';
                                    if (vol >= 1000) return (vol / 1000).toFixed(2) + 'K';
                                    return vol.toFixed(2);
                                  } else if (coin?.unitsTraded) {
                                    const vol = parseFloat(coin.unitsTraded);
                                    if (vol >= 1000000) return (vol / 1000000).toFixed(2) + 'M';
                                    if (vol >= 1000) return (vol / 1000).toFixed(2) + 'K';
                                    return vol.toFixed(2);
                                  }
                                  return '-';
                                })()} {selectedCoin}
                              </span>
                            </div>
                            
                            {/* Í±∞ÎûòÎåÄÍ∏à */}
                            <div className="flex justify-between">
                              <div className="flex items-center space-x-2">
                                <span className="font-semibold text-gray-900 dark:text-gray-100">Í±∞ÎûòÎåÄÍ∏à</span>
                                <span className="text-xs text-gray-400 dark:text-gray-500">(ÏµúÍ∑º24ÏãúÍ∞Ñ)</span>
                              </div>
                              <span className="font-mono text-gray-900 dark:text-gray-100">
                                {(() => {
                                  const rt = realTimeData[selectedCoin + '_KRW'];
                                  const coin = coinList.find(c => c.symbol === selectedCoin);
                                  
                                  let vol = 0;
                                  let price = 0;
                                  
                                  if (rt?.volume && rt.volume > 0) {
                                    vol = parseFloat(rt.volume);
                                    price = parseFloat(rt.closePrice);
                                  } else if (coin?.unitsTraded && coin?.price) {
                                    vol = parseFloat(coin.unitsTraded);
                                    price = parseFloat(coin.price);
                                  }
                                  
                                  if (vol > 0 && price > 0) {
                                    const total = vol * price;
                                    if (total >= 1000000000000) return (total / 1000000000000).toFixed(2) + 'T';
                                    if (total >= 1000000000) return (total / 1000000000).toFixed(2) + 'B';
                                    if (total >= 1000000) return (total / 1000000).toFixed(2) + 'M';
                                    if (total >= 1000) return (total / 1000).toFixed(2) + 'K';
                                    return total.toFixed(0);
                                  }
                                  return '-';
                                })()} KRW
                              </span>
                            </div>
                                                        
                            {/* 24h ÏµúÍ≥† */}
                            <div className="flex justify-between">
                              <span className="font-semibold text-gray-900 dark:text-gray-100">24h ÏµúÍ≥†</span>
                              <span className="font-mono text-red-500 dark:text-red-400">
                                {(() => {
                                  const rt = realTimeData[selectedCoin + '_KRW'];
                                  const coin = coinList.find(c => c.symbol === selectedCoin);
                                  
                                  let price = 0;
                                  if (rt?.highPrice && rt.highPrice > 0) {
                                    price = parseFloat(rt.highPrice);
                                  } else if (coin?.high24h) {
                                    price = parseFloat(coin.high24h);
                                  }
                                  
                                  if (price > 0) {
                                    if (price < 1) return price.toFixed(4);
                                    if (price < 10) return price.toFixed(4);
                                    if (price < 100) return price.toFixed(2);
                                    if (price < 1000) return Math.round(price).toLocaleString();
                                    if (price < 10000) return Math.round(price).toLocaleString();
                                    if (price < 100000) return (Math.round(price / 10) * 10).toLocaleString();
                                    if (price < 1000000) return (Math.round(price / 100) * 100).toLocaleString();
                                    return (Math.round(price / 1000) * 1000).toLocaleString();
                                  }
                                  return '-';
                                })()}
                              </span>
                            </div>
                            
                            {/* 24h ÏµúÏ†Ä */}
                            <div className="flex justify-between">
                              <span className="font-semibold text-gray-900 dark:text-gray-100">24h ÏµúÏ†Ä</span>
                              <span className="font-mono text-blue-500 dark:text-blue-400">
                                {(() => {
                                  const rt = realTimeData[selectedCoin + '_KRW'];
                                  const coin = coinList.find(c => c.symbol === selectedCoin);
                                  
                                  let price = 0;
                                  if (rt?.lowPrice && rt.lowPrice > 0) {
                                    price = parseFloat(rt.lowPrice);
                                  } else if (coin?.low24h) {
                                    price = parseFloat(coin.low24h);
                                  }
                                  
                                  if (price > 0) {
                                    if (price < 1) return price.toFixed(4);
                                    if (price < 10) return price.toFixed(4);
                                    if (price < 100) return price.toFixed(2);
                                    if (price < 1000) return Math.round(price).toLocaleString();
                                    if (price < 10000) return Math.round(price).toLocaleString();
                                    if (price < 100000) return (Math.round(price / 10) * 10).toLocaleString();
                                    if (price < 1000000) return (Math.round(price / 100) * 100).toLocaleString();
                                    return (Math.round(price / 1000) * 1000).toLocaleString();
                                  }
                                  return '-';
                                })()}
                              </span>
                            </div>
                            
                            {/* ÏãúÍ∞ÄÏ¥ùÏï° */}
                            <div className="flex justify-between">
                              <span className="font-semibold text-gray-900 dark:text-gray-100">ÏãúÍ∞ÄÏ¥ùÏï°</span>
                              <span className="font-mono text-gray-900 dark:text-gray-100">
                                {(() => {
                                  const coin = coinList.find(c => c.symbol === selectedCoin);
                                  if (coin?.marketCap) {
                                    const cap = parseFloat(coin.marketCap);
                                    if (cap >= 1000000000000) return (cap / 1000000000000).toFixed(1) + 'T';
                                    if (cap >= 1000000000) return (cap / 1000000000).toFixed(1) + 'B';
                                    if (cap >= 1000000) return (cap / 1000000).toFixed(1) + 'M';
                                    if (cap >= 1000) return (cap / 1000).toFixed(1) + 'K';
                                    return cap.toFixed(0);
                                  }
                                  return '-';
                                })()} KRW
                              </span>
                            </div>
                            
                            {/* Ïú†ÌÜµÎüâ */}
                            <div className="flex justify-between">
                              <span className="font-semibold text-gray-900 dark:text-gray-100">Ïú†ÌÜµÎüâ</span>
                              <span className="font-mono text-gray-900 dark:text-gray-100">
                                {(() => {
                                  const coin = coinList.find(c => c.symbol === selectedCoin);
                                  if (coin?.circulatingSupply) {
                                    const supply = parseFloat(coin.circulatingSupply);
                                    if (supply >= 1000000000) return (supply / 1000000000).toFixed(2) + 'B';
                                    if (supply >= 1000000) return (supply / 1000000).toFixed(2) + 'M';
                                    if (supply >= 1000) return (supply / 1000).toFixed(2) + 'K';
                                    return supply.toFixed(2);
                                  }
                                  return '-';
                                })()}
                              </span>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>

      </div>
    </div>
  );
}
